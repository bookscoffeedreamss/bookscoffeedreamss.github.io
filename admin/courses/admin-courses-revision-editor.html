<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Revision Editor • BCD (Chapter UI)</title>

  <!-- Tailwind (quick) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  
  <!-- SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Cloudinary Widget -->
  <script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>

  <!-- KaTeX for formula rendering -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>

  <style>
    /* Chapter Content Editor theme (light glass) adapted */
    :root{
      --bg-1: #FFFBFF;
      --bg-2: #F3F7FF;
      --accent-a: #A855F7; /* purple */
      --accent-b: #6366F1; /* indigo */
      --muted: #6b7280;
      --glass: rgba(255,255,255,0.9);
      --glass-border: rgba(99,102,241,0.06);
      --text-dark: #0b1220;
    }

    html,body{height:100%}
    body{
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;
      margin:0;
      background: linear-gradient(135deg, var(--bg-1) 0%, var(--bg-2) 100%);
      color:var(--text-dark);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow-y:overlay;
    }

    .glow {
      position:fixed;
      filter: blur(80px);
      opacity:0.9;
      z-index:0;
      pointer-events:none;
    }
    .glow.g1{ width:420px; height:420px; top:-80px; left:-80px; background: radial-gradient(circle at 30% 30%, rgba(168,85,247,0.28), rgba(99,102,241,0.14), transparent 40%); }
    .glow.g2{ width:360px; height:360px; bottom:-60px; right:-40px; background: radial-gradient(circle at 70% 70%, rgba(99,102,241,0.22), rgba(34,211,238,0.10), transparent 40%); }

    .app-shell{ display:flex; height:100vh; position:relative; z-index:1; }

    .glass {
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.92));
      border-radius:14px;
      box-shadow: 0 6px 30px rgba(20,24,40,0.06);
      border:1px solid var(--glass-border);
      padding:16px;
    }

    header.app-header {
      height:72px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:0 22px;
      margin:18px;
    }
    .header-left{ display:flex; align-items:center; gap:12px; }
    .back-btn {
      display:flex; align-items:center; gap:8px;
      background:transparent; border:0; cursor:pointer; padding:8px; border-radius:10px;
    }
    .back-btn:hover{ background: rgba(0,0,0,0.03) }

    .header-title{ font-weight:800; font-size:18px; color:var(--text-dark); }
    .header-sub{ font-size:13px; color:var(--muted); margin-left:6px; font-weight:600; }

    .header-right{ display:flex; align-items:center; gap:12px; }

    .profile-btn{
      display:flex; align-items:center; gap:8px; padding:6px 10px; border-radius:12px;
      background:linear-gradient(90deg,var(--accent-a),var(--accent-b)); color:white; font-weight:700;
      cursor:pointer; border:0;
    }

    .nav-item { display:flex; align-items:center; gap:12px; padding:10px; border-radius:10px; cursor:pointer; color:var(--text-dark); font-weight:700; }
    .nav-item:hover{ background:rgba(99,102,241,0.06); }
    .nav-item .icon { width:34px; height:34px; display:inline-flex; align-items:center; justify-content:center; border-radius:8px; background:linear-gradient(135deg, rgba(168,85,247,0.12), rgba(99,102,241,0.12)); color:var(--accent-b); }

    .main { flex:1; padding:22px; overflow:auto; box-sizing:border-box; position:relative; }

    .panel { padding:18px; border-radius:12px; background:rgba(255,255,255,0.95); border:1px solid rgba(99,102,241,0.06); box-shadow:0 6px 24px rgba(16,24,40,0.04); }

    .muted { color:var(--muted); }
    .pill { background:transparent; border:1px solid rgba(16,24,40,0.06); padding:10px; border-radius:10px; color:var(--text-dark); }
    .input { width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(16,24,40,0.06); background:rgba(255,255,255,0.9); box-sizing:border-box; font-weight:600; color:var(--text-dark); }
    .input:focus{ outline:none; box-shadow:0 8px 30px rgba(99,102,241,0.06); border-color:rgba(99,102,241,0.18); }

    .btn { padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer; border:0; }
    .btn-ghost { background:transparent; border:1px solid rgba(16,24,40,0.05); color:var(--text-dark); }
    .btn-primary { background:linear-gradient(90deg,var(--accent-a),var(--accent-b)); color:white; box-shadow: 0 10px 30px rgba(99,102,241,0.08); }

    .list-item {
      background:rgba(255,255,255,0.98);
      border-radius:10px;
      padding:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border:1px solid rgba(16,24,40,0.03);
      list-style: none !important;
      position: relative;
      padding-left: 36px;
    }

    .thumb { width:56px; height:56px; object-fit:cover; border-radius:8px; background:linear-gradient(135deg, rgba(99,102,241,0.06), rgba(168,85,247,0.06)); display:block; }
    .small { font-size:13px; color:var(--muted); }
    .hr { height:1px; background:rgba(16,24,40,0.04); margin:10px 0; border-radius:2px; }

    /* Tabs style 3 (glass card tabs) */
    .tabs-row { display:flex; gap:12px; margin-bottom:12px; }
    .tab-card {
      padding:10px 14px; border-radius:12px; cursor:pointer; background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.95));
      border:1px solid rgba(16,24,40,0.04); box-shadow: 0 6px 18px rgba(16,24,40,0.03); font-weight:800;
      display:inline-flex; gap:8px; align-items:center;
    }
    .tab-card.active { border:1px solid rgba(99,102,241,0.12); box-shadow: 0 10px 30px rgba(99,102,241,0.06); }

    .hidden { display:none; }

    @media (max-width:1024px){
      .app-sidebar{ display:none; }
      header.app-header{ margin:12px; }
      .main { padding:12px; }
    }

    .fade-in { animation: fadeIn 360ms ease both; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(6px) } to { opacity:1; transform:none } }

    /* Revision Editor specific adjustments (matching Chapter UI look) */
    .rev-left { width: 220px; flex-shrink:0; display:flex; flex-direction:column; gap:16px; }
    .rev-right { flex:1; display:flex; flex-direction:column; gap:16px; }

    /* block palette styles matched to chapter look */
    .block-btn { display:flex; gap:10px; align-items:center; padding:10px 12px; border-radius:10px; cursor:pointer; border:1px solid rgba(16,24,40,0.04); background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.96)); color:var(--text-dark); font-weight:700; }
    .block-btn:hover { background:linear-gradient(180deg, rgba(249,250,251,1), rgba(255,255,255,0.98)); box-shadow: 0 8px 30px rgba(99,102,241,0.04); transform:translateY(-2px); }

    .blocks-list { display:flex; flex-direction:column; gap:8px; margin-top:6px; max-height:45vh; overflow:auto; padding-right:6px; }

    /* editor area styles */
    .editor-toolbar { display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .editor-canvas { min-height:360px; max-height:65vh; overflow:auto; padding:12px; border-radius:10px; border:1px dashed rgba(16,24,40,0.04); background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.96)); }

    .block-card { background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.97)); border-radius:10px; padding:12px; margin-bottom:10px; border:1px solid rgba(16,24,40,0.03); display:flex; gap:12px; align-items:flex-start; }
    .block-card .meta { width:120px; min-width:120px; font-size:13px; color:var(--muted); }
    .block-card .body { flex:1; min-width:0; }
    .block-actions { display:flex; gap:6px; align-items:center; }

    .input, textarea, select { width:100%; padding:8px 10px; border-radius:8px; border:1px solid rgba(16,24,40,0.04); background:rgba(255,255,255,0.94); color:var(--text-dark); font-size:13px; }
    textarea { min-height:84px; resize:vertical; }

    .small { font-size:12px; color:var(--muted); }

    .btn { padding:8px 10px; border-radius:8px; font-weight:700; cursor:pointer; border:1px solid rgba(16,24,40,0.04); background:transparent; color:var(--text-dark); }
    .btn-primary { background:linear-gradient(90deg,var(--accent-a),var(--accent-b)); border:none; color:white; box-shadow:0 8px 30px rgba(99,102,241,0.08); }
    .btn-ghost { background:transparent; }

    .preview { background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.96)); padding:12px; border-radius:8px; border:1px solid rgba(16,24,40,0.04); color:var(--text-dark); }

    .hint { font-size:12px; color:var(--muted); margin-top:6px; }

    @media (max-width:1024px){
      .rev-left{ width:100%; } 
    }
    /* --- Block card visual upgrade --- */
.block-card {
  background: white;                 /* cleaner surface */
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 14px;
  border: 1px solid rgba(16,24,40,0.04);
  box-shadow: 0 6px 20px rgba(16,24,40,0.04);
  transition: transform .16s ease, box-shadow .16s ease;
  display:flex;
  gap:12px;
  align-items:flex-start;
}

/* lift on hover */
.block-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 14px 40px rgba(16,24,40,0.07);
}

/* meta column reduced width so body gets more space */
.block-card .meta { width:100px; min-width:100px; font-size:13px; color:var(--muted); }

/* nicer body area */
.block-card .body { flex:1; min-width:0; }

/* small badge for block type */
.block-type-badge {
  display:inline-block;
  padding:4px 8px;
  border-radius:8px;
  background: rgba(99,102,241,0.10);
  color: var(--accent-b);
  font-weight:800;
  font-size:12px;
  margin-bottom:6px;
}

/* icon style for small toolbar buttons */
.icon-btn {
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:6px;
  border-radius:8px;
  border:1px solid rgba(16,24,40,0.04);
  background:transparent;
  cursor:pointer;
  width:36px;
  height:36px;
  transition: background .12s, color .12s, transform .12s;
}
.icon-btn:hover {
  background: rgba(99,102,241,0.10);
  color:var(--accent-b);
  transform:translateY(-2px);
}

/* small divider to split categories and controls */
.block-divider { height:1px; background:rgba(16,24,40,0.04); margin:10px 0; border-radius:2px; }

/* drag handle visual */
.drag-handle {
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:30px;
  height:30px;
  border-radius:8px;
  cursor:grab;
  color:rgba(11,18,32,0.5);
}
.drag-handle:active { cursor:grabbing; }

/* responsive tweak: stack meta above on small screens */
@media (max-width:760px) {
  .block-card { flex-direction:column; }
  .block-card .meta { width:100%; min-width:auto; display:flex; justify-content:space-between; align-items:center; gap:8px; }
}
  </style>
</head>
<body>
  <div class="glow g1"></div>
  <div class="glow g2"></div>

  <!-- Header (same as Chapter Content Editor) -->
  <header class="app-header">
    <div class="header-left">
      <button class="back-btn glass" id="backArrow" title="Go back">
        <i class="fa-solid fa-arrow-left" style="color:var(--accent-b);"></i>
        <div style="font-weight:700; color:var(--text-dark)">Back</div>
      </button>
      <div>
        <div class="header-title">Revision Editor — BCD</div>
        <div class="header-sub">Build revision notes using blocks</div>
      </div>
    </div>

    <div class="header-right">
      <div class="small muted">Course ID:</div>
      <div id="courseIdDisplay" class="pill">—</div>
      <button id="saveBtnTop" class="btn btn-primary">Save</button>
      <img id="profilePic" class="w-10 h-10 rounded-full object-cover border border-white/20 cursor-pointer hover:opacity-80 transition" src="" alt="Profile">
    </div>
  </header>

  <div class="app-shell">
    <!-- Main content area -->
    <main class="main">
      <!-- Top controls (subject + chapter) -->
      <div class="panel fade-in mb-6">
        <div class="flex items-center justify-between">
          <div>
            <div style="font-weight:800; font-size:18px; display:flex; gap:10px; align-items:center">
              <img src="/assets/icons/hashtag_2.png" style="width:20px;height:20px;object-fit:contain;opacity:.9" />
              Revision Note Hub
            </div>
            <div class="small muted">Create revision notes for a chapter. Uses KaTeX for formulas.</div>
          </div>

          <div style="min-width:320px" class="flex items-center gap-3">
            <select id="subjectSelect" class="input" style="max-width:280px"></select>
            <select id="chapterSelect" class="input" style="max-width:220px"></select>
            <button id="saveBtn" class="btn btn-primary">Save</button>
          </div>
        </div>
      </div>

      <!-- Main editor area: left palette + right editor & preview -->
      <div class="panel mb-6" style="display:flex;gap:16px;align-items:flex-start;">
        <!-- Left palette (styled like chapter panels) -->
        <div class="rev-left">
          <div class="panel">
            <div style="font-weight:800; display:flex; gap:8px; align-items:center">
              <img src="/assets/icons/selection.png" style="width:18px;height:18px" />
              <span>Revision Blocks</span>
            </div>
            <div class="small muted">Add blocks to build the revision note (All blocks included)</div>

            <div class="blocks-list" id="blockPalette" style="margin-top:12px">
              <div class="block-btn" data-type="heading"><i class="fa-solid fa-heading"></i> <div><div style="font-weight:700">Heading</div><div class="small muted">H1/H2/H3</div></div></div>
              <div class="block-btn" data-type="paragraph"><i class="fa-solid fa-paragraph"></i> <div><div style="font-weight:700">Paragraph</div><div class="small muted">Rich paragraph</div></div></div>
              <div class="block-btn" data-type="image"><i class="fa-solid fa-image"></i> <div><div style="font-weight:700">Image</div><div class="small muted">Upload/copy URL</div></div></div>
              <div class="block-btn" data-type="imageText"><i class="fa-solid fa-columns"></i> <div><div style="font-weight:700">Image + Text</div><div class="small muted">Side-by-side</div></div></div>
              <div class="block-btn" data-type="bullets"><i class="fa-solid fa-list"></i> <div><div style="font-weight:700">Bullet List</div><div class="small muted">Multiple bullets</div></div></div>
              <div class="block-btn" data-type="numbered"><i class="fa-solid fa-list-ol"></i> <div><div style="font-weight:700">Numbered List</div><div class="small muted">Ordered</div></div></div>
              <div class="block-btn" data-type="keypoints"><i class="fa-solid fa-star"></i> <div><div style="font-weight:700">Important Points</div><div class="small muted">Category-based</div></div></div>
              <div class="block-btn" data-type="confusions"><i class="fa-solid fa-question-circle"></i> <div><div style="font-weight:700">Common Confusions</div><div class="small muted">Category-based</div></div></div>
              <div class="block-btn" data-type="formulas"><i class="fa-solid fa-superscript"></i> <div><div style="font-weight:700">Formula Sheet</div><div class="small muted">LaTeX/KaTeX</div></div></div>
              <div class="block-btn" data-type="tableImage"><i class="fa-solid fa-table"></i> <div><div style="font-weight:700">Table / Flowchart</div><div class="small muted">Image or grid</div></div></div>
              <div class="block-btn" data-type="example"><i class="fa-solid fa-lightbulb"></i> <div><div style="font-weight:700">Example</div><div class="small muted">Worked example</div></div></div>
              <div class="block-btn" data-type="warning"><i class="fa-solid fa-triangle-exclamation"></i> <div><div style="font-weight:700">Warning / Pitfall</div><div class="small muted">Highlight mistakes</div></div></div>
            </div>

            <div class="hr" style="margin-top:12px"></div>

            <div style="margin-top:8px">
              <div class="small muted">Quick Actions</div>
              <div style="display:flex;gap:8px;margin-top:10px;">
                <button id="uploadImageGlobal" class="btn btn-ghost"><i class="fa-solid fa-upload"></i> Upload Image</button>
                <button id="insertTemplateKeypoints" class="btn btn-primary">Keypoints Template</button>
              </div>
              <div class="hint">Use template to prefill common structures</div>
            </div>
          </div>

          <div class="panel" style="margin-top:12px">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div style="font-weight:800">Save / Export</div>
              <div class="small muted">Course actions</div>
            </div>
            <div style="display:flex;gap:8px;margin-top:10px;">
              <button id="saveBtnLeft" class="btn btn-primary"><i class="fa-solid fa-floppy-disk"></i> Save</button>
              <button id="exportJSON" class="btn btn-ghost">Export JSON</button>
            </div>
            <div style="margin-top:8px" class="small muted">Course ID: <span id="courseIdDisplaySmall" class="pill">—</span></div>
          </div>
        </div>

        <!-- Right editor & preview -->
        <div class="rev-right" style="flex:1">
          <div class="panel">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div>
                <div style="font-weight:800; font-size:18px">Revision Note Editor</div>
                <div class="small muted">Build rich revision notes with blocks — live preview & KaTeX support</div>
              </div>

              <div style="display:flex;gap:8px;align-items:center;">
                <label class="toggle small muted"><input type="checkbox" id="previewToggle" checked/> Live Preview</label>
                <button id="undoBtn" class="btn">Undo</button>
                <button id="redoBtn" class="btn">Redo</button>
              </div>
            </div>

            <div class="editor-toolbar" style="margin-top:12px;">
              <div class="small muted">Editor canvas</div>
              <div style="display:flex;gap:8px;align-items:center;">
                <button id="addBlockBtn" class="btn">Add Block</button>
                <button id="clearAllBlocks" class="btn">Clear All</button>
              </div>
            </div>

            <div class="editor-canvas" id="editorCanvas" style="margin-top:12px;">
              <!-- blocks will be rendered here -->
            </div>
          </div>

          <div class="panel">
            <div style="font-weight:800">Preview</div>
            <div id="previewArea" class="preview" style="min-height:180px; margin-top:8px;"></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- FIREBASE + LOGIC (Revision Editor core preserved, adapted to this page) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, doc, getDoc, updateDoc, setDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { requirePermission } from "/admin/guard-v10.js";

    // ---------- CONFIG ----------
    const firebaseConfig = {
      apiKey: "AIzaSyACEG_4v-3ROgMNOlFZsAllC9VcYb8Nm2A",
      authDomain: "bcd-discord.firebaseapp.com",
      projectId: "bcd-discord",
      storageBucket: "bcd-discord.appspot.com",
      messagingSenderId: "278895155371",
      appId: "1:278895155371:web:177a468f5fa3f0abfe3fee"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Cloudinary
    const CLOUD_NAME = 'dkxuilgai';
    const UPLOAD_PRESET = 'bcd_courses';
    function openCloudinaryWidget(opts = {}, cb) {
      const widget = cloudinary.createUploadWidget({
        cloudName: CLOUD_NAME,
        uploadPreset: UPLOAD_PRESET,
        sources: ["local","url","camera"],
        multiple: !!opts.multiple,
        resourceType: opts.resourceType || 'image',
        clientAllowedFormats: opts.clientAllowedFormats || undefined
      }, (err, result) => {
        if (!err && result && result.event === 'success') cb(result.info);
        if (err) { console.error('Cloudinary error', err); Swal.fire('Upload error', err.message || 'Upload failed', 'error'); }
      });
      widget.open();
    }

    // ---------- STATE ----------
    let courseId = null;
    let CONTENT = { revision: { subjects: {} } }; // fallback structure
    let SUBJECTS_LIST = []; // from course content or external
    let SELECTED_SUBJECT_ID = null;
    let SELECTED_CHAPTER_ID = null;
    let BLOCKS = []; // array of blocks for current chapter
    let history = { past: [], future: [] };
    let saveLock = false;
    let isDirty = false;

    // ---------- DOM ----------
    const blockPalette = document.getElementById('blockPalette');
    const editorCanvas = document.getElementById('editorCanvas');
    const previewArea = document.getElementById('previewArea');
    const saveBtn = document.getElementById('saveBtn'); // top right save inside panel (exists)
    const saveBtnTop = document.getElementById('saveBtnTop'); // header save
    const saveBtnLeft = document.getElementById('saveBtnLeft'); // left save
    const courseIdDisplay = document.getElementById('courseIdDisplay');
    const courseIdDisplaySmall = document.getElementById('courseIdDisplaySmall');
    const subjectSelect = document.getElementById('subjectSelect');
    const chapterSelect = document.getElementById('chapterSelect');
    const uploadImageGlobal = document.getElementById('uploadImageGlobal');
    const insertTemplateKeypoints = document.getElementById('insertTemplateKeypoints');
    const previewToggle = document.getElementById('previewToggle');
    const addBlockBtn = document.getElementById('addBlockBtn');
    const clearAllBlocks = document.getElementById('clearAllBlocks');
    const exportJSON = document.getElementById('exportJSON');
    const undoBtn = document.getElementById('undoBtn');
    const redoBtn = document.getElementById('redoBtn');

    // small helpers (escape)
    function escapeHtml(s=''){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
    function escapeAttr(s=''){ return String(s||'').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }

    // ---------- Helpers ----------
    function uid(pref='b'){ return pref + '_' + Math.random().toString(36).slice(2,9); }
    function markDirty(){ isDirty = true; }
    function pushHistory(snapshot){
      history.past.push(JSON.stringify(snapshot));
      if(history.past.length>100) history.past.shift();
      history.future = []; // clear redo
    }
    // ⭐ ADD THIS DEBOUNCE CODE HERE
function debounce(fn, wait = 120){
  let t;
  return (...args)=>{
    clearTimeout(t);
    t = setTimeout(()=>fn(...args), wait);
  };
}
const debouncedPreview = debounce(renderPreview, 120);

    function undo(){
      if(!history.past.length) return;
      const cur = JSON.stringify(BLOCKS);
      history.future.push(cur);
      const prev = history.past.pop();
      BLOCKS = JSON.parse(prev);
      renderEditor();
      renderPreview();
    }
    function redo(){
      if(!history.future.length) return;
      const cur = JSON.stringify(BLOCKS);
      history.past.push(cur);
      const next = history.future.pop();
      BLOCKS = JSON.parse(next);
      renderEditor();
      renderPreview();
    }

    // ---------- Block factory ----------
    function defaultBlock(type){
      const base = { id: uid('blk'), type, meta:{}, toggles:{}, categories: [] };
      switch(type){
        case 'heading': return {...base, level:1, text:'Heading text' };
        case 'paragraph': return {...base, text:'Write explanation here...' };
        case 'image': return {...base, url:'', caption:'' };
        case 'imageText': return {...base, imageUrl:'', text:'Explanation for image', imageLeft:true };
        case 'bullets': return {...base, items: ['Point 1','Point 2'] };
        case 'numbered': return {...base, items: ['Step 1','Step 2'] };
        case 'keypoints': return {...base, items: ['Key 1','Key 2'] };
        case 'confusions': return {...base, items: ['Confusion 1']};
        case 'formulas': return {...base, formulas: ['E=mc^2','F = ma']};
        case 'tableImage': return {...base, url:'', caption:''};
        case 'example': return {...base, title:'Example', steps:['Step 1','Solution...'] };
        case 'warning': return {...base, text:'Watch out for this common error' };
        default: return {...base};
      }
    }

    // ---------- UI: add block ----------
    blockPalette.querySelectorAll('.block-btn').forEach(btn=>{
      btn.addEventListener('click', ()=> {
        const type = btn.dataset.type;
        addBlock(type);
      });
    });
    addBlockBtn.addEventListener('click', ()=> {
      addBlock('paragraph');
    });

    function addBlock(type){
      const b = defaultBlock(type);
      pushHistory(BLOCKS);
      BLOCKS.push(b);
      renderEditor();
      renderPreview();
      markDirty();
    }

    // ---------- Render editor ----------
    function renderEditor(){
      editorCanvas.innerHTML = '';
      if(!BLOCKS.length){
        editorCanvas.innerHTML = `<div class="small muted">No blocks yet — use the left palette to add blocks.</div>`;
        return;
      }

      BLOCKS.forEach((b, idx)=>{
        const card = document.createElement('div');
        card.className = 'block-card';
        card.dataset.id = b.id;
        card.innerHTML = `
          <div class="meta">
  <div style="display:flex;flex-direction:column;gap:6px;">
    <span class="block-type-badge">${escapeHtml(capitalize(b.type))}</span>
    <div class="small muted">#${idx+1}</div>
  </div>

  <div style="margin-top:8px" class="block-actions" aria-hidden="true">
    <button class="icon-btn" data-act="duplicate" title="Duplicate"><i class="fa-solid fa-copy"></i></button>
    <button class="icon-btn" data-act="remove" title="Remove"><i class="fa-solid fa-trash"></i></button>
    <button class="icon-btn" data-act="up" title="Move up"><i class="fa-solid fa-arrow-up"></i></button>
    <button class="icon-btn" data-act="down" title="Move down"><i class="fa-solid fa-arrow-down"></i></button>
    <span class="drag-handle" title="Drag to reorder"><i class="fa-solid fa-grip-vertical"></i></span>
  </div>
</div>
          <div class="body" id="body_${b.id}"></div>
        `;
        editorCanvas.appendChild(card);

        const body = card.querySelector(`#body_${b.id}`);

        // render block-specific controls (same as original revision editor)
        if(b.type === 'heading'){
          body.innerHTML = `
          <!-- CATEGORY TAGS -->
    <div style="margin-bottom:10px;">
      <div class="small muted" style="font-weight:600;margin-bottom:4px;">Categories</div>
      <div style="display:flex;flex-wrap:wrap;gap:8px;">
        <label class="toggle small muted"><input type="checkbox" data-cat="keypoints"> Key Pointers</label>
        <label class="toggle small muted"><input type="checkbox" data-cat="diagrams"> Diagrams & Graphs</label>
        <label class="toggle small muted"><input type="checkbox" data-cat="tables"> Tables & Flowcharts</label>
        <label class="toggle small muted"><input type="checkbox" data-cat="confusions"> Common Confusions</label>
        <label class="toggle small muted"><input type="checkbox" data-cat="formulas"> Formulas</label>
      </div>
    </div>
            <div style="display:flex;gap:8px;">
              <select class="input" data-prop="level">
                <option value="1"${b.level===1?' selected':''}>H1</option>
                <option value="2"${b.level===2?' selected':''}>H2</option>
                <option value="3"${b.level===3?' selected':''}>H3</option>
              </select>
            </div>
            <div style="margin-top:8px;">
              <input class="input" data-prop="text" value="${escapeHtml(b.text)}" />
            </div>
          `;
        } else if(b.type === 'paragraph'){
          body.innerHTML = `
          <!-- CATEGORY TAGS -->
<div style="margin-bottom:10px;">
  <div class="small muted" style="font-weight:600;margin-bottom:4px;">Categories</div>
  <div style="display:flex;flex-wrap:wrap;gap:8px;">
    <label class="toggle small muted">
      <input type="checkbox" data-cat="keypoints"> Key Pointers
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="diagrams"> Diagrams & Graphs
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="tables"> Tables & Flowcharts
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="confusions"> Common Confusions
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="formulas"> Formulas
    </label>
  </div>
</div>
<textarea class="input" data-prop="text">${escapeHtml(b.text)}</textarea>`;
        } else if(b.type === 'image'){
          body.innerHTML = `
          <!-- CATEGORY TAGS -->
<div style="margin-bottom:10px;">
  <div class="small muted" style="font-weight:600;margin-bottom:4px;">Categories</div>
  <div style="display:flex;flex-wrap:wrap;gap:8px;">
    <label class="toggle small muted">
      <input type="checkbox" data-cat="keypoints"> Key Pointers
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="diagrams"> Diagrams & Graphs
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="tables"> Tables & Flowcharts
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="confusions"> Common Confusions
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="formulas"> Formulas
    </label>
  </div>
</div>

            <div style="display:flex;gap:8px;">
              <input class="input" placeholder="Image URL" data-prop="url" value="${escapeHtml(b.url||'')}" />
              <button class="btn" data-act="upload">Upload</button>
            </div>
            <div style="margin-top:8px"><input class="input" placeholder="Caption (optional)" data-prop="caption" value="${escapeHtml(b.caption||'')}" /></div>
          `;
        } else if(b.type === 'imageText'){
          body.innerHTML = `
          <!-- CATEGORY TAGS -->
<div style="margin-bottom:10px;">
  <div class="small muted" style="font-weight:600;margin-bottom:4px;">Categories</div>
  <div style="display:flex;flex-wrap:wrap;gap:8px;">
    <label class="toggle small muted">
      <input type="checkbox" data-cat="keypoints"> Key Pointers
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="diagrams"> Diagrams & Graphs
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="tables"> Tables & Flowcharts
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="confusions"> Common Confusions
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="formulas"> Formulas
    </label>
  </div>
</div>

            <div style="display:flex;gap:8px;">
              <input class="input" placeholder="Image URL" data-prop="imageUrl" value="${escapeHtml(b.imageUrl||'')}" />
              <button class="btn" data-act="upload">Upload</button>
              <label class="toggle"><input type="checkbox" data-prop="imageLeft" ${b.imageLeft ? 'checked' : ''} /> Image left</label>
            </div>
            <div style="margin-top:8px"><textarea class="input" data-prop="text">${escapeHtml(b.text||'')}</textarea></div>
          `;
        } else if(b.type === 'bullets' || b.type === 'numbered'){
          body.innerHTML = `
          <!-- CATEGORY TAGS -->
<div style="margin-bottom:10px;">
  <div class="small muted" style="font-weight:600;margin-bottom:4px;">Categories</div>
  <div style="display:flex;flex-wrap:wrap;gap:8px;">
    <label class="toggle small muted">
      <input type="checkbox" data-cat="keypoints"> Key Pointers
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="diagrams"> Diagrams & Graphs
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="tables"> Tables & Flowcharts
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="confusions"> Common Confusions
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="formulas"> Formulas
    </label>
  </div>
</div>
<div data-list></div><div style="display:flex;gap:8px;margin-top:8px;"><input class="input" placeholder="New item" data-add /><button class="btn" data-act="addItem">Add</button></div>`;
          const listDiv = body.querySelector('[data-list]');
          (b.items || []).forEach((it,i)=>{
            const row = document.createElement('div');
            row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center'; row.style.marginTop='8px';
            row.innerHTML = `<input class="input" data-item-index="${i}" value="${escapeHtml(it)}" /><button class="btn" data-act="removeItem" data-i="${i}">Remove</button>`;
            listDiv.appendChild(row);
          });
        } else if(b.type === 'keypoints' || b.type === 'confusions'){
          body.innerHTML = `
          <!-- CATEGORY TAGS -->
<div style="margin-bottom:10px;">
  <div class="small muted" style="font-weight:600;margin-bottom:4px;">Categories</div>
  <div style="display:flex;flex-wrap:wrap;gap:8px;">
    <label class="toggle small muted">
      <input type="checkbox" data-cat="keypoints"> Key Pointers
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="diagrams"> Diagrams & Graphs
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="tables"> Tables & Flowcharts
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="confusions"> Common Confusions
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="formulas"> Formulas
    </label>
  </div>
</div>

            <div style="display:flex;gap:8px;align-items:center;">
        
            </div>
            <div data-list style="margin-top:8px"></div>
            <div style="display:flex;gap:8px;margin-top:8px;"><input class="input" placeholder="New item" data-add /><button class="btn" data-act="addItem">Add</button></div>
          `;
          const listDiv = body.querySelector('[data-list]');
          (b.items||[]).forEach((it,i)=>{
            const row = document.createElement('div');
            row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center'; row.style.marginTop='8px';
            row.innerHTML = `<input class="input" data-item-index="${i}" value="${escapeHtml(it)}" /><button class="btn" data-act="removeItem" data-i="${i}">Remove</button>`;
            listDiv.appendChild(row);
          });
        } else if(b.type === 'formulas'){
          body.innerHTML = `
          <!-- CATEGORY TAGS -->
<div style="margin-bottom:10px;">
  <div class="small muted" style="font-weight:600;margin-bottom:4px;">Categories</div>
  <div style="display:flex;flex-wrap:wrap;gap:8px;">
    <label class="toggle small muted">
      <input type="checkbox" data-cat="keypoints"> Key Pointers
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="diagrams"> Diagrams & Graphs
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="tables"> Tables & Flowcharts
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="confusions"> Common Confusions
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="formulas"> Formulas
    </label>
  </div>
</div>

            <div style="display:flex;gap:8px;align-items:center;"></div>
            <div data-formulas style="margin-top:8px"></div>
            <div style="display:flex;gap:8px;margin-top:8px;"><input class="input" placeholder="LaTeX formula (e.g. \\frac{a}{b})" data-add /><button class="btn" data-act="addFormula">Add Formula</button></div>
          `;
          const fdiv = body.querySelector('[data-formulas]');
          (b.formulas||[]).forEach((f,i)=>{
            const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center'; row.style.marginTop='8px';
            row.innerHTML = `<input class="input" data-formula-index="${i}" value="${escapeHtml(f)}" /><div class="btn" data-act="removeFormula" data-i="${i}">Remove</div>`;
            fdiv.appendChild(row);
          });
        } else if(b.type === 'tableImage'){
          body.innerHTML = `
          <!-- CATEGORY TAGS -->
<div style="margin-bottom:10px;">
  <div class="small muted" style="font-weight:600;margin-bottom:4px;">Categories</div>
  <div style="display:flex;flex-wrap:wrap;gap:8px;">
    <label class="toggle small muted">
      <input type="checkbox" data-cat="keypoints"> Key Pointers
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="diagrams"> Diagrams & Graphs
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="tables"> Tables & Flowcharts
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="confusions"> Common Confusions
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="formulas"> Formulas
    </label>
  </div>
</div>

            <div style="display:flex;gap:8px;">
              <input class="input" placeholder="Image URL" data-prop="url" value="${escapeHtml(b.url||'')}" />
              <button class="btn" data-act="upload">Upload</button>
            </div>
            <div style="margin-top:8px;"><input class="input" placeholder="Caption" data-prop="caption" value="${escapeHtml(b.caption||'')}" /></div>
            <div style="margin-top:8px;"></div>
          `;
        } else if(b.type === 'example'){
          body.innerHTML = `
          <!-- CATEGORY TAGS -->
<div style="margin-bottom:10px;">
  <div class="small muted" style="font-weight:600;margin-bottom:4px;">Categories</div>
  <div style="display:flex;flex-wrap:wrap;gap:8px;">
    <label class="toggle small muted">
      <input type="checkbox" data-cat="keypoints"> Key Pointers
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="diagrams"> Diagrams & Graphs
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="tables"> Tables & Flowcharts
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="confusions"> Common Confusions
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="formulas"> Formulas
    </label>
  </div>
</div>

            <input class="input" data-prop="title" placeholder="Example title" value="${escapeHtml(b.title||'')}" />
            <div data-steps style="margin-top:8px"></div>
            <div style="display:flex;gap:8px;margin-top:8px;"><input class="input" placeholder="New step" data-add /><button class="btn" data-act="addStep">Add Step</button></div>
          `;
          const sdiv = body.querySelector('[data-steps]');
          (b.steps||[]).forEach((s,i)=>{
            const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center'; row.style.marginTop='8px';
            row.innerHTML = `<input class="input" data-step-index="${i}" value="${escapeHtml(s)}"/><div class="btn" data-act="removeStep" data-i="${i}">Remove</div>`;
            sdiv.appendChild(row);
          });
        } else if(b.type === 'warning'){
          body.innerHTML = `
          <!-- CATEGORY TAGS -->
<div style="margin-bottom:10px;">
  <div class="small muted" style="font-weight:600;margin-bottom:4px;">Categories</div>
  <div style="display:flex;flex-wrap:wrap;gap:8px;">
    <label class="toggle small muted">
      <input type="checkbox" data-cat="keypoints"> Key Pointers
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="diagrams"> Diagrams & Graphs
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="tables"> Tables & Flowcharts
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="confusions"> Common Confusions
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="formulas"> Formulas
    </label>
  </div>
</div>

          <textarea class="input" data-prop="text">${escapeHtml(b.text||'')}</textarea>`;
        } else {
          body.innerHTML = `
          <!-- CATEGORY TAGS -->
<div style="margin-bottom:10px;">
  <div class="small muted" style="font-weight:600;margin-bottom:4px;">Categories</div>
  <div style="display:flex;flex-wrap:wrap;gap:8px;">
    <label class="toggle small muted">
      <input type="checkbox" data-cat="keypoints"> Key Pointers
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="diagrams"> Diagrams & Graphs
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="tables"> Tables & Flowcharts
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="confusions"> Common Confusions
    </label>
    <label class="toggle small muted">
      <input type="checkbox" data-cat="formulas"> Formulas
    </label>
  </div>
</div>
<div class="small muted">Unknown block type</div>`;
        }

        // attach events in this block
        attachBlockEvents(b, card);
      });
      initSortableEditor();
    }
    
let _sortableEditor = null;

function initSortableEditor() {
  if (_sortableEditor) {
    try { _sortableEditor.destroy(); } catch (e) {}
  }

  _sortableEditor = new Sortable(editorCanvas, {
    animation: 150,
    handle: ".drag-handle",
    ghostClass: "sortable-ghost",
    onEnd: evt => {
      const oldIndex = evt.oldIndex;
      const newIndex = evt.newIndex;
      if (oldIndex === newIndex) return;

      pushHistory(BLOCKS);
      const moved = BLOCKS.splice(oldIndex, 1)[0];
      BLOCKS.splice(newIndex, 0, moved);

      renderEditor();
      renderPreview();
      markDirty();
    }
  });
}


    // ---------- Attach block events ----------
    function attachBlockEvents(block, cardEl){
      // actions: up/down/remove/duplicate
      cardEl.querySelectorAll('[data-act]').forEach(btn=>{
        btn.addEventListener('click', async (ev)=>{
          const act = btn.dataset.act;
          if(act === 'up'){
            const idx = BLOCKS.findIndex(x=>x.id===block.id);
            if(idx>0){ pushHistory(BLOCKS); [BLOCKS[idx-1], BLOCKS[idx]] = [BLOCKS[idx], BLOCKS[idx-1]]; renderEditor(); renderPreview(); markDirty(); }
          } else if(act === 'down'){
            const idx = BLOCKS.findIndex(x=>x.id===block.id);
            if(idx < BLOCKS.length-1){ pushHistory(BLOCKS); [BLOCKS[idx+1], BLOCKS[idx]] = [BLOCKS[idx], BLOCKS[idx+1]]; renderEditor(); renderPreview(); markDirty(); }
          } else if(act === 'remove'){
            const conf = await Swal.fire({ title:'Delete block?', text:'This will remove the block', icon:'warning', showCancelButton:true });
            if(conf.isConfirmed){ pushHistory(BLOCKS); BLOCKS = BLOCKS.filter(b=>b.id!==block.id); renderEditor(); renderPreview(); markDirty(); }
          } else if(act === 'duplicate'){
            pushHistory(BLOCKS);
            const copy = JSON.parse(JSON.stringify(block)); copy.id = uid('blk');
            BLOCKS.splice(BLOCKS.findIndex(x=>x.id===block.id)+1, 0, copy);
            renderEditor(); renderPreview(); markDirty();
          } else if(act === 'upload'){
            // upload image for this block
            openCloudinaryWidget({ resourceType:'image' }, info=>{
              // find relevant prop (image/url)
              if(block.type === 'image'){ block.url = info.secure_url; }
              else if(block.type === 'imageText'){ block.imageUrl = info.secure_url; }
              else if(block.type === 'tableImage'){ block.url = info.secure_url; }
              renderEditor(); renderPreview(); markDirty();
            });
          } else if(act === 'addItem'){
            const inp = cardEl.querySelector('[data-add]');
            const val = inp && inp.value.trim();
            if(val){
              pushHistory(BLOCKS);
              block.items = block.items || []; block.items.push(val);
              inp.value = '';
              renderEditor(); renderPreview(); markDirty();
            }
          } else if(act === 'removeItem'){
            pushHistory(BLOCKS);
            block.items.splice(+btn.dataset.i,1);
            renderEditor(); renderPreview(); markDirty();
          } else if(act === 'addFormula'){
            const inp = cardEl.querySelector('[data-add]');
            const val = inp && inp.value.trim();
            if(val){ pushHistory(BLOCKS); block.formulas = block.formulas || []; block.formulas.push(val); inp.value=''; renderEditor(); renderPreview(); markDirty(); }
          } else if(act === 'removeFormula'){
            pushHistory(BLOCKS); block.formulas.splice(+btn.dataset.i,1); renderEditor(); renderPreview(); markDirty();
          } else if(act === 'addStep'){
            const inp = cardEl.querySelector('[data-add]');
            const v = inp && inp.value.trim();
            if(v){ pushHistory(BLOCKS); block.steps = block.steps || []; block.steps.push(v); inp.value=''; renderEditor(); renderPreview(); markDirty(); }
          } else if(act === 'removeStep'){
            pushHistory(BLOCKS); block.steps.splice(+btn.dataset.i,1); renderEditor(); renderPreview(); markDirty();
          }
        });
      });

      // property bindings (inputs/selects/textareas)
      cardEl.querySelectorAll('input[data-prop], textarea[data-prop], select[data-prop]').forEach(inp=>{
        inp.addEventListener('input', ()=> {
          const prop = inp.dataset.prop;
          if (inp.type === 'checkbox') {
  if (block.toggles && prop in block.toggles) {
    block.toggles[prop] = inp.checked;
  } else {
    block[prop] = inp.checked;
  }
} else {
  if (block.toggles && prop in block.toggles) {
    block.toggles[prop] = inp.value;
  } else {
    block[prop] = inp.value;
  }
}
          debouncedPreview();
          markDirty();
        });
      });

      // dynamic list edits (inline edits)
      cardEl.querySelectorAll('[data-item-index]').forEach(inp=>{
        inp.addEventListener('input', ()=> {
          const i = +inp.dataset.itemIndex;
          block.items[i] = inp.value;
          debouncedPreview();
          markDirty();
        });
      });
      cardEl.querySelectorAll('[data-formula-index]').forEach(inp=>{
        inp.addEventListener('input', ()=> {
          const i = +inp.dataset.formulaIndex;
          block.formulas[i] = inp.value;
          debouncedPreview();
          markDirty();
        });
      });
      cardEl.querySelectorAll('[data-step-index]').forEach(inp=>{
        inp.addEventListener('input', ()=> {
          const i = +inp.dataset.stepIndex;
          block.steps[i] = inp.value;
          debouncedPreview();
          markDirty();
        });
      });
      // CATEGORY CHECKBOXES
cardEl.querySelectorAll('[data-cat]').forEach(box => {
  const cat = box.dataset.cat;

  // initial checked state
  box.checked = block.categories?.includes(cat);

  box.addEventListener('change', () => {
    if (box.checked) {
      if (!block.categories.includes(cat)) block.categories.push(cat);
    } else {
      block.categories = block.categories.filter(c => c !== cat);
    }
    markDirty();
    renderPreview();
  });
});

    }

    // ---------- Render preview ----------
    function renderPreview(){
      if(!previewToggle.checked){ previewArea.innerHTML = '<div class="small muted">Preview is disabled</div>'; return; }
      let html = '';
      BLOCKS.forEach(b=>{
        html += renderBlockToHTML(b);
      });
      previewArea.innerHTML = html;
      // render formulas with KaTeX
      previewArea.querySelectorAll('[data-katex]').forEach(el=>{
        const tex = el.dataset.katex;
        try{
          el.innerHTML = katex.renderToString(tex, { throwOnError:false, displayMode:true });
        }catch(e){
          el.innerText = tex;
        }
      });
    }

    function renderBlockToHTML(b){
      if(b.type === 'heading'){
        const lvl = b.level || 1;
        const tag = lvl===1? 'h1' : lvl===2? 'h2' : 'h3';
        return `<${tag} style="margin:8px 0;color:var(--text-dark);font-weight:800">${escapeHtml(b.text||'')}</${tag}>`;
      } else if(b.type === 'paragraph'){
        return `<div style="margin:6px 0;line-height:1.5;color:var(--text-dark)">${escapeHtml(b.text||'')}</div>`;
      } else if(b.type === 'image'){
        return `<div style="margin:10px 0;"><img src="${escapeAttr(b.url||'')}" style="max-width:100%;border-radius:8px"/><div class="small muted">${escapeHtml(b.caption||'')}</div></div>`;
      } else if(b.type === 'imageText'){
        const left = b.imageLeft !== false;
        const imgHtml = `<img src="${escapeAttr(b.imageUrl||'')}" style="width:220px;height:auto;border-radius:8px;object-fit:cover" onerror="this.style.display='none'"/>`;
        const txtHtml = `<div style="padding:6px 8px;color:var(--text-dark)">${escapeHtml(b.text||'')}</div>`;
        return `<div style="display:flex;gap:12px;align-items:flex-start;margin:10px 0">${ left ? imgHtml + txtHtml : txtHtml + imgHtml }</div>`;
      } else if(b.type === 'bullets'){
        const items = (b.items||[]).map(i=>`<li>${escapeHtml(i)}</li>`).join('');
        return `<ul style="margin:8px 0 8px 18px;color:var(--text-dark)">${items}</ul>`;
      } else if(b.type === 'numbered'){
        const items = (b.items||[]).map(i=>`<li>${escapeHtml(i)}</li>`).join('');
        return `<ol style="margin:8px 0 8px 18px;color:var(--text-dark)">${items}</ol>`;
      } else if(b.type === 'keypoints'){
        const items = (b.items||[]).map(i=>`<li>${escapeHtml(i)}</li>`).join('');
        return `<div style="border-left:4px solid #f59e0b;padding:10px;margin:10px 0;background:rgba(245,158,11,0.04)"><strong>Key Points</strong><ul style="margin-top:8px">${items}</ul></div>`;
      } else if(b.type === 'confusions'){
        const items = (b.items||[]).map(i=>`<li>${escapeHtml(i)}</li>`).join('');
        return `<div style="border-left:4px solid #ef4444;padding:10px;margin:10px 0;background:rgba(239,68,68,0.03)"><strong>Common Confusions</strong><ul style="margin-top:8px">${items}</ul></div>`;
      } else if(b.type === 'formulas'){
        const frm = (b.formulas||[]).map(f=>`<div data-katex="${escapeAttr(f)}"></div>`).join('');
        return `<div style="margin:10px 0;padding:10px;border-radius:8px;background:rgba(255,255,255,0.01)"><strong>Formulas</strong>${frm}</div>`;
      } else if(b.type === 'tableImage'){
        return `<div style="margin:10px 0;"><img src="${escapeAttr(b.url||'')}" style="max-width:100%;border-radius:6px"/><div class="small muted">${escapeHtml(b.caption||'')}</div></div>`;
      } else if(b.type === 'example'){
        const steps = (b.steps||[]).map(s=>`<li>${escapeHtml(s)}</li>`).join('');
        return `<div style="margin:10px 0;padding:10px;border-radius:8px;background:rgba(99,102,241,0.04)"><strong>${escapeHtml(b.title||'Example')}</strong><ol style="margin-top:8px">${steps}</ol></div>`;
      } else if(b.type === 'warning'){
        return `<div style="margin:10px 0;padding:10px;border-radius:8px;background:rgba(244,63,94,0.06);border-left:4px solid #ef4444"><strong>Warning</strong><div style="margin-top:6px">${escapeHtml(b.text||'')}</div></div>`;
      } else {
        return `<div class="small muted">Unknown block: ${escapeHtml(b.type)}</div>`;
      }
    }

    // ---------- Save / Load ----------
    async function saveRevisionContent(){
      if(!courseId) return Swal.fire('Missing course ID','Open page with ?id=<courseId>','error');
      if(!SELECTED_SUBJECT_ID || !SELECTED_CHAPTER_ID) return Swal.fire('Select chapter','Choose subject & chapter to save revision notes','warning');
      if(saveLock) return;
      saveLock = true;
      try{
        const courseRef = doc(db,'courses',courseId);
        const snap = await getDoc(courseRef);
        const courseData = snap.exists() ? snap.data() : {};
        const revision = courseData.revision || { subjects:{} };
        if(!revision.subjects) revision.subjects = {};
        revision.subjects[SELECTED_SUBJECT_ID] = revision.subjects[SELECTED_SUBJECT_ID] || { chapters:{} };
        revision.subjects[SELECTED_SUBJECT_ID].chapters = revision.subjects[SELECTED_SUBJECT_ID].chapters || {};
        revision.subjects[SELECTED_SUBJECT_ID].chapters[SELECTED_CHAPTER_ID] = { blocks: BLOCKS, updatedAt: serverTimestamp() };
        await updateDoc(courseRef, { revision, updatedAt: serverTimestamp() });
        Swal.fire({ icon:'success', title:'Saved', text:'Revision notes saved', timer:1100, showConfirmButton:false });
        isDirty = false;
      }catch(err){
        console.error('save err', err);
        Swal.fire('Error','Failed to save revision notes','error');
      } finally { saveLock = false; }
    }

    // wire save buttons
    saveBtn?.addEventListener('click', saveRevisionContent);
    saveBtnTop?.addEventListener('click', saveRevisionContent);
    saveBtnLeft?.addEventListener('click', saveRevisionContent);

    exportJSON.addEventListener('click', ()=>{
      const json = JSON.stringify({ subject: SELECTED_SUBJECT_ID, chapter: SELECTED_CHAPTER_ID, blocks: BLOCKS }, null, 2);
      const blob = new Blob([json], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `revision_${SELECTED_CHAPTER_ID||'export'}.json`; a.click();
      URL.revokeObjectURL(url);
    });

    // ---------- Load course content and subjects/chapters ----------
    function getQueryParam(name){ const u = new URL(window.location.href); return u.searchParams.get(name); }

    async function loadCourseAndRevision(id){
      try{
        const snap = await getDoc(doc(db,'courses',id));
        if(!snap.exists()){ Swal.fire('Not found','Course not found','error'); return; }
        const data = snap.data();
        let subjectsSource = {};
        if(data.content && data.content.subjects) subjectsSource = data.content.subjects;
        else if(data.subjects) subjectsSource = data.subjects;
        else subjectsSource = {};
        if(Object.keys(subjectsSource).length){
          SUBJECTS_LIST = Object.keys(subjectsSource).map(id => ({ id, name: subjectsSource[id].name || subjectsSource[id].title || 'Unnamed' , meta: subjectsSource[id] }));
        } else if(data.revision && data.revision.subjects){
          SUBJECTS_LIST = Object.keys(data.revision.subjects).map(id => ({ id, name: data.revision.subjects[id].name || id, meta: data.revision.subjects[id] }));
        } else {
          SUBJECTS_LIST = [];
        }
        CONTENT = data;
        courseId = id;
        courseIdDisplay.textContent = courseId;
        courseIdDisplaySmall.textContent = courseId;
        populateSubjectSelect();
        if(SUBJECTS_LIST.length){
          SELECTED_SUBJECT_ID = SUBJECTS_LIST[0].id;
          populateChapterSelectFromSource();
        } else {
          SELECTED_SUBJECT_ID = null;
          SELECTED_CHAPTER_ID = null;
          BLOCKS = [];
          renderEditor(); renderPreview();
        }
        isDirty = false;
      }catch(err){
        console.error('load course err', err);
        Swal.fire('Error','Failed to load course','error');
      }
    }

    function populateSubjectSelect(){
      subjectSelect.innerHTML = '';
      SUBJECTS_LIST.forEach(s=>{
        const opt = document.createElement('option'); opt.value = s.id; opt.textContent = s.name; subjectSelect.appendChild(opt);
      });
      if(SELECTED_SUBJECT_ID) subjectSelect.value = SELECTED_SUBJECT_ID;
      subjectSelect.onchange = ()=> { SELECTED_SUBJECT_ID = subjectSelect.value; populateChapterSelectFromSource(); };
    }

    function populateChapterSelectFromSource(){
      chapterSelect.innerHTML = '';
      const courseData = CONTENT;
      let chaptersSource = null;
      if(courseData.content && courseData.content.subjects && courseData.content.subjects[SELECTED_SUBJECT_ID] && courseData.content.subjects[SELECTED_SUBJECT_ID].chapters){
        chaptersSource = courseData.content.subjects[SELECTED_SUBJECT_ID].chapters;
      } else if(courseData.revision && courseData.revision.subjects && courseData.revision.subjects[SELECTED_SUBJECT_ID] && courseData.revision.subjects[SELECTED_SUBJECT_ID].chapters){
        const chObj = courseData.revision.subjects[SELECTED_SUBJECT_ID].chapters;
        chaptersSource = Object.keys(chObj).map(k=>({ id:k, title: chObj[k].title || k }));
      } else {
        chaptersSource = [];
      }

      let chaptersNormalized = [];
      if(Array.isArray(chaptersSource)){
        chaptersNormalized = chaptersSource.map(ch => ({ id: ch.id || uid('ch'), title: ch.title || ch.name || 'Untitled' }));
      } else if(typeof chaptersSource === 'object'){
        if(Object.keys(chaptersSource).length){
          chaptersNormalized = Object.keys(chaptersSource).map(k => ({ id:k, title: chaptersSource[k].title || chaptersSource[k].name || k }));
        }
      }

      chaptersNormalized.forEach(ch=>{
        const opt = document.createElement('option'); opt.value = ch.id; opt.textContent = ch.title; chapterSelect.appendChild(opt);
      });

      if(chaptersNormalized.length){
        SELECTED_CHAPTER_ID = chaptersNormalized[0].id;
        chapterSelect.value = SELECTED_CHAPTER_ID;
        chapterSelect.onchange = ()=> { SELECTED_CHAPTER_ID = chapterSelect.value; loadRevisionBlocksForSelected(); };
        loadRevisionBlocksForSelected();
      } else {
        SELECTED_CHAPTER_ID = null;
        BLOCKS = [];
        chapterSelect.innerHTML = '';
        const em = document.createElement('option'); em.value=''; em.textContent='— no chapters —'; chapterSelect.appendChild(em);
        renderEditor(); renderPreview();
      }
    }

    async function loadRevisionBlocksForSelected(){
      if(!CONTENT) CONTENT = {};
      const revision = CONTENT.revision || {};
      if(revision.subjects && revision.subjects[SELECTED_SUBJECT_ID] && revision.subjects[SELECTED_SUBJECT_ID].chapters && revision.subjects[SELECTED_SUBJECT_ID].chapters[SELECTED_CHAPTER_ID]){
        BLOCKS = revision.subjects[SELECTED_SUBJECT_ID].chapters[SELECTED_CHAPTER_ID].blocks || [];
      } else {
        BLOCKS = [];
      }
      BLOCKS = JSON.parse(JSON.stringify(BLOCKS));
      history = { past: [], future: [] };
      renderEditor();
      renderPreview();
    }

    // ---------- Quick actions ----------
    uploadImageGlobal.addEventListener('click', ()=> {
      openCloudinaryWidget({ resourceType:'image' }, info=>{
        Swal.fire('Uploaded','Image URL copied to clipboard','success');
        navigator.clipboard?.writeText(info.secure_url).catch(()=>{});
      });
    });

    insertTemplateKeypoints.addEventListener('click', ()=> {
      pushHistory(BLOCKS);
      BLOCKS.push(defaultBlock('keypoints'));
      renderEditor(); renderPreview(); markDirty();
    });

    clearAllBlocks.addEventListener('click', async ()=>{
      const r = await Swal.fire({ title:'Clear all blocks?', text:'This will remove all blocks in current chapter', icon:'warning', showCancelButton:true });
      if(r.isConfirmed){ pushHistory(BLOCKS); BLOCKS = []; renderEditor(); renderPreview(); markDirty(); }
    });

    undoBtn.addEventListener('click', undo);
    redoBtn.addEventListener('click', redo);

    window.addEventListener('beforeunload', (e)=> { if(isDirty){ e.preventDefault(); e.returnValue=''; } });

    // NEW PERMISSION GUARD
    (async ()=>{
      const perm = await requirePermission("manageSubjects");
      const user = perm.user || perm?.currentUser || null;
      const role = perm.role || perm?.userRole || null;

      // profile pic
      const profilePic = document.getElementById("profilePic");
      const defaultPic = "https://raw.githubusercontent.com/bookscoffeedreams/bookscoffeedreams.github.io/main/assets/images/account_logo_default.png";
      profilePic.src = user?.photoURL || role?.photoURL || defaultPic;
      profilePic.onclick = ()=> window.location.href = 'profile.html';

      const idParam = getQueryParam("id");
      if(!idParam){
        Swal.fire("Missing id","Open this page with ?id=<courseId>","warning");
      } else {
        courseId = idParam;
        courseIdDisplay.textContent = courseId;
        courseIdDisplaySmall.textContent = courseId;
        await loadCourseAndRevision(courseId);
      }
    })();

    // header back arrow
    document.getElementById('backArrow').onclick = ()=> {
      if (window.history.length > 1) window.history.back();
      else window.location.href = 'admin-subjects.html';
    };

    // preview toggle wiring
    previewToggle.addEventListener('change', ()=> renderPreview());

    // keyboard save
    window.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); saveRevisionContent(); } });
  </script>
</body>
</html>
