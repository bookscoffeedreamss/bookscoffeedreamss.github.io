<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin • Manage Courses — BCD</title>

  <!-- Fonts + Tailwind -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Cloudinary Upload Widget -->
  <script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>

  <link href="/logo.png" rel="icon">

  <style>
    body { font-family: 'Inter', sans-serif; background: linear-gradient(to bottom right,#f3e8ff,#ede9fe); }
    .card { background: white; border-radius: 12px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.06); }
    .role-badge { padding:.25rem .6rem; border-radius:999px; font-weight:600; font-size:.8rem; }
    .btn { padding: 10px 14px; border-radius: 10px; font-weight:600; }
    .small { font-size: .92rem; }
    .scroll-y { max-height: 60vh; overflow: auto; }
  </style>
</head>

<body class="min-h-screen p-6">
  <div class="max-w-6xl mx-auto">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-3xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-purple-600 to-indigo-500">
          Manage Courses
        </h1>
        <p class="text-sm text-gray-600">Create basic course entries (quick create) and open full course editor. Cloudinary used for media uploads.</p>
      </div>

      <div class="flex items-center gap-3">
        <input id="searchInput" placeholder="Search by title..." class="px-4 py-2 rounded-xl border border-gray-200 shadow-sm w-72" />
        <button id="refreshBtn" class="btn bg-white border border-gray-200 shadow-sm">Refresh</button>
        <button id="addCourseBtn" class="btn bg-gradient-to-r from-purple-600 to-indigo-600 text-white">+ Add Course</button>
      </div>
    </div>

    <div id="courseList" class="grid gap-4"></div>
  </div>

  <!-- Create Course Modal (simple) -->
  <div id="createModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="card w-full max-w-2xl relative">
      <button id="closeCreate" class="absolute right-4 top-4 text-gray-600">✖</button>

      <div class="px-4 py-6">
        <h2 id="createTitle" class="text-2xl font-bold mb-4">Create Course (Basic)</h2>

        <form id="createForm" class="space-y-4">
          <div>
            <label class="text-sm font-semibold">Title</label>
            <input id="c_title" class="input mt-1 w-full p-3 rounded-lg border" required />
          </div>

          <div>
            <label class="text-sm font-semibold">Short Description</label>
            <textarea id="c_description" rows="3" class="input mt-1 w-full p-3 rounded-lg border"></textarea>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="text-sm font-semibold">Price (INR)</label>
              <input id="c_price" type="number" min="0" class="input mt-1 w-full p-3 rounded-lg border" />
            </div>
            <div>
              <label class="text-sm font-semibold">Duration</label>
              <input id="c_duration" class="input mt-1 w-full p-3 rounded-lg border" />
            </div>
            <div>
              <label class="text-sm font-semibold">Featured</label>
              <select id="c_featured" class="input mt-1 w-full p-3 rounded-lg border">
                <option value="false">No</option>
                <option value="true">Yes</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="text-sm font-semibold">Exam Tags (comma separated)</label>
              <input id="c_tags" class="input mt-1 w-full p-3 rounded-lg border" placeholder="JEE, NEET, Boards" />
            </div>
            <div>
              <label class="text-sm font-semibold">Thumbnail</label>
              <div class="flex gap-2 items-center mt-1">
                <img id="c_thumbPreview" src="" alt="" class="w-28 h-16 object-cover rounded-md border hidden" />
                <button id="c_uploadThumbBtn" type="button" class="btn bg-white border">Upload</button>
                <button id="c_removeThumbBtn" type="button" class="btn bg-red-50">Remove</button>
              </div>
            </div>
          </div>

          <div class="flex justify-end gap-2">
            <button id="createCourseBtn" class="btn bg-gradient-to-r from-purple-600 to-indigo-600 text-white">Create & Open Editor</button>
            <button id="createCancelBtn" type="button" class="btn bg-white border">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Firebase + Logic -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc, deleteDoc, doc,
    onSnapshot, query, orderBy, serverTimestamp, getDoc
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // NEW GUARD (no old auth)
  import { requirePermission } from "/admin/guard-v10.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyACEG_4v-3ROgMNOlFZsAllC9VcYb8Nm2A",
    authDomain: "bcd-discord.firebaseapp.com",
    projectId: "bcd-discord",
    storageBucket: "bcd-discord.appspot.com",
    messagingSenderId: "278895155371",
    appId: "1:278895155371:web:177a468f5fa3f0abfe3fee"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // CLOUDINARY
  const CLOUD_NAME = "dkxuilgai";
  const UPLOAD_PRESET = "bcd_courses";

  function openCloudinaryWidget(options = {}, callback) {
    const widget = cloudinary.createUploadWidget({
      cloudName: CLOUD_NAME,
      uploadPreset: UPLOAD_PRESET,
      sources: ["local","url","camera"],
      multiple: options.multiple || false,
      resourceType: options.resourceType || "image",
    }, (err, result) => {
      if (!err && result && result.event === "success") {
        callback(result.info);
      }
    });
    widget.open();
  }

  /* -----------------------------------------------------
        NEW AUTH GUARD — the ONLY access check
  ----------------------------------------------------- */
  const { user, role } = await requirePermission("manageCourses");
  // If user passes the guard → code continues automatically

  /* -----------------------------------------------------
        Rest of your original code continues EXACTLY same
  ----------------------------------------------------- */

  const courseList = document.getElementById("courseList");
  const addCourseBtn = document.getElementById("addCourseBtn");
  const createModal = document.getElementById("createModal");
  const closeCreate = document.getElementById("closeCreate");
  const createCancelBtn = document.getElementById("createCancelBtn");
  const createCourseBtn = document.getElementById("createCourseBtn");
  const searchInput = document.getElementById("searchInput");
  const refreshBtn = document.getElementById("refreshBtn");

  const c_title = document.getElementById("c_title");
  const c_description = document.getElementById("c_description");
  const c_price = document.getElementById("c_price");
  const c_duration = document.getElementById("c_duration");
  const c_tags = document.getElementById("c_tags");
  const c_featured = document.getElementById("c_featured");
  const c_thumbPreview = document.getElementById("c_thumbPreview");
  const c_uploadThumbBtn = document.getElementById("c_uploadThumbBtn");
  const c_removeThumbBtn = document.getElementById("c_removeThumbBtn");

  function showCreateModal() {
    createModal.classList.remove("hidden");
    createModal.classList.add("flex");
    window.scrollTo(0,0);
  }

  function hideCreateModal() {
    createModal.classList.add("hidden");
    createModal.classList.remove("flex");
    resetCreateForm();
  }

  function resetCreateForm() {
    c_title.value = "";
    c_description.value = "";
    c_price.value = "";
    c_duration.value = "";
    c_tags.value = "";
    c_featured.value = "false";
    c_thumbPreview.src = "";
    c_thumbPreview.classList.add("hidden");
  }

  c_uploadThumbBtn.onclick = () => {
    openCloudinaryWidget({}, (info) => {
      c_thumbPreview.src = info.secure_url;
      c_thumbPreview.classList.remove("hidden");
    });
  };

  c_removeThumbBtn.onclick = () => {
    c_thumbPreview.src = "";
    c_thumbPreview.classList.add("hidden");
  };

  /* -----------------------------------------------------
        Start listening to courses NOW (auth already verified)
  ----------------------------------------------------- */
  let unsubscribe = null;
  startListeningCourses();
  function startListeningCourses() {
    if (unsubscribe) unsubscribe();
    const q = query(collection(db, "courses"), orderBy("createdAt", "desc"));
    unsubscribe = onSnapshot(q, (snapshot) => {
      const rows = [];
      snapshot.forEach(d => rows.push({ id: d.id, ...d.data() }));
      renderCourseList(rows);
    });
  }

  /* ---- render list, filters, buttons (same as yours) ---- */

  let currentCourses = [];
  function renderCourseList(courses) {
    currentCourses = courses;
    const filter = (searchInput.value || "").toLowerCase();
    courseList.innerHTML = "";

    const filtered = courses.filter(c =>
      (c.title || "").toLowerCase().includes(filter) ||
      (c.description || "").toLowerCase().includes(filter)
    );

    if (filtered.length === 0) {
      courseList.innerHTML = `<div class="card p-6 text-gray-500">No courses found.</div>`;
      return;
    }

    filtered.forEach(c => {
      const card = document.createElement("div");
      const thumb = c.thumbnailURL || "https://raw.githubusercontent.com/bookscoffeedreams/bookscoffeedreams.github.io/main/assets/images/prarambh_3.0.png";

      card.className = "card flex flex-col md:flex-row items-start gap-4 p-4";
      card.innerHTML = `
        <div class="w-full md:w-40">
          <img src="${thumb}" class="w-full h-28 object-cover rounded-md border" />
        </div>
        <div class="flex-1">
          <div class="flex justify-between items-start">
            <div>
              <div class="text-lg font-bold">${c.title}</div>
              <div class="text-sm text-gray-600">${(c.description || "").slice(0,140)}${(c.description||"").length>140?"...":""}</div>
              <div class="text-xs text-gray-500 mt-2">
                Teachers: ${
                  c.teachers?.length
                    ? c.teachers.map(t => t.name).join(", ")
                    : "<span class='text-red-500 font-semibold'>Not selected</span>"
                }
              </div>
              <div class="text-xs text-gray-500">Tags: ${(c.tags||[]).join(", ")}</div>
            </div>

            <div class="text-right small">
              <div>${c.featured ? '<span class="role-badge role-admin">Featured</span>' : ''}</div>
              <div class="mt-2 font-semibold text-purple-600">₹ ${c.price ?? 0}</div>
              <div class="text-xs text-gray-500 mt-1">${c.duration || ""}</div>
            </div>
          </div>

          <div class="mt-3 flex gap-2">
            <button data-id="${c.id}" class="editBtn btn bg-white border">Edit</button>
            <button data-id="${c.id}" class="contentBtn btn bg-purple-50">Content</button>
            <button data-id="${c.id}" class="deleteBtn btn bg-red-50">Delete</button>
            <button data-id="${c.id}" class="viewBtn btn bg-white border">View JSON</button>
          </div>
        </div>
      `;

      courseList.appendChild(card);
    });

    attachListListeners();
  }

  function attachListListeners() {
    document.querySelectorAll(".editBtn").forEach(b =>
      b.onclick = e => {
        window.location.href =
          "admin-courses-editor.html?id=" + encodeURIComponent(e.currentTarget.dataset.id);
      }
    );

    document.querySelectorAll(".contentBtn").forEach(b =>
      b.onclick = e => {
        window.location.href =
          "admin-courses-content.html?id=" + encodeURIComponent(e.currentTarget.dataset.id);
      }
    );

    document.querySelectorAll(".deleteBtn").forEach(b =>
      b.onclick = e => confirmDeleteCourse(e.currentTarget.dataset.id)
    );

    document.querySelectorAll(".viewBtn").forEach(b =>
      b.onclick = async e => {
        const id = e.currentTarget.dataset.id;
        const snap = await getDoc(doc(db, "courses", id));
        Swal.fire({
          title: "Course JSON",
          html: `<pre>${JSON.stringify(snap.data(), null, 2)}</pre>`,
          width: 800
        });
      }
    );
  }

  addCourseBtn.onclick = showCreateModal;
  closeCreate.onclick = hideCreateModal;
  createCancelBtn.onclick = hideCreateModal;

  createCourseBtn.onclick = async (e) => {
    e.preventDefault();
    const payload = {
      title: c_title.value.trim(),
      description: c_description.value.trim(),
      price: Number(c_price.value) || 0,
      duration: c_duration.value.trim(),
      tags: c_tags.value.split(",").map(s => s.trim()).filter(Boolean),
      featured: c_featured.value === "true",
      thumbnailURL:
        !c_thumbPreview.classList.contains("hidden") ? c_thumbPreview.src : "",
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    };

    const docRef = await addDoc(collection(db, "courses"), payload);
    Swal.fire("Created", "Course created.", "success");

    hideCreateModal();
    window.location.href = `admin-courses-editor.html?id=${encodeURIComponent(docRef.id)}`;
  };

  async function confirmDeleteCourse(id) {
    const res = await Swal.fire({
      title: "Delete course?",
      text: "This action cannot be undone.",
      icon: "warning",
      showCancelButton: true,
    });
    if (!res.isConfirmed) return;
    await deleteDoc(doc(db, "courses", id));
    Swal.fire("Deleted", "", "success");
  }

  searchInput.oninput = () => renderCourseList(currentCourses);
  refreshBtn.onclick = () => startListeningCourses();
</script>
</body>
</html>
