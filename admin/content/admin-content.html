<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="/logo.png" rel="icon">
  <title>Manage Content | Books Coffee and Dreams</title>
  
  <!-- Fonts + Tailwind -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tools -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <style>
    :root { --accent1: #7c3aed; --accent2: #6d28d9; --glass-bg: rgba(255,255,255,0.65); }
    body { font-family: Inter, sans-serif; background: linear-gradient(180deg,#f6f1ff, #efe8ff); min-height: 100vh; }
    .sidebar {
      background: linear-gradient(180deg, #eadeff, #d1b8ff, #b99cff);
      border-radius: 24px;
      padding: 24px;
      width: 270px;
      box-shadow: 0 12px 32px rgba(120, 69, 255, 0.12);
      height: 100%;
      flex-shrink: 0;
    }
    .nav-item {
      display: flex; align-items: center; gap: 12px; padding: 10px 14px;
      font-size: 15px; color: rgba(15, 23, 42, 0.95); border-radius: 10px; cursor: pointer;
      transition: 0.18s; white-space: nowrap;
    }
    .nav-item:hover { background: rgba(255,255,255,0.6); transform: translateX(4px); }
    .nav-active { background: rgba(255,255,255,0.85); font-weight: 700; box-shadow: 0 6px 18px rgba(99,102,241,0.08); }
    .card { background: #fff; border-radius: 16px; padding: 22px; box-shadow: 0 6px 26px rgba(13,14,18,0.04); }
    .input-rounded { border-radius: 10px; }
    .big-banner-preview { width: 100%; height: 220px; object-fit: cover; border-radius: 12px; display:block; }
    .flex-gap { gap: 12px; display:flex; align-items:center; }
    .muted { color: #6b7280; font-size: 0.95rem; }

    /* ICONS - Premium Glass Card Grid */
    .subjects-grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(240px,1fr)); gap:18px; margin-top:18px; }
    .subject-card { position: relative; background: linear-gradient(180deg, rgba(255,255,255,0.75), rgba(255,255,255,0.6)); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.6); padding:16px; border-radius:14px; box-shadow: 0 8px 30px rgba(69,57,163,0.06); transition: transform .18s, box-shadow .18s; }
    .subject-card:hover { transform: translateY(-6px); box-shadow: 0 18px 40px rgba(99,102,241,0.12); }
    .subject-card .title { font-weight:700; font-size:15px; display:flex; align-items:center; gap:12px; }
    .subject-card .meta { color:#6b7280; font-size:13px; margin-top:6px; }
    .subject-actions { position:absolute; top:10px; right:10px; display:flex; gap:6px; }
    .btn-ghost { background: transparent; border: none; padding:6px 8px; border-radius:8px; cursor:pointer; font-size:14px; }

    .chapter-grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(84px,1fr)); gap:10px; margin-top:12px; }
    .chapter-tile { width:100%; aspect-ratio:1/1; border-radius:12px; overflow:hidden; display:flex; align-items:center; justify-content:center; position:relative; background:linear-gradient(180deg,#fff,#f3f2ff); box-shadow: 0 6px 14px rgba(8,7,25,0.04); }
    .chapter-tile img { width:70%; height:70%; object-fit:contain; border-radius:8px; }
    .chapter-actions { position:absolute; top:6px; right:6px; display:flex; gap:6px; }
    .fab-upload { position: absolute; bottom: 14px; right: 14px; background: linear-gradient(90deg,var(--accent1),var(--accent2)); color:#fff; border:none; width:48px; height:48px; border-radius:999px; display:flex; align-items:center; justify-content:center; font-size:24px; box-shadow: 0 8px 18px rgba(124,58,237,0.28); cursor:pointer; }

    /* modal styles (Swal default looks good; small helper) */
    .small-muted { color:#9aa0b0; font-size:13px; }

    /* responsive */
    @media (max-width:960px){ .sidebar{ width:100%; height:auto; border-radius:12px } .layout{ flex-direction:column; gap:18px; padding:16px } .subjects-grid{ grid-template-columns: repeat(auto-fill,minmax(180px,1fr)); } }
  </style>
</head>

<body>
  <div class="flex layout gap-8 max-w-7xl mx-auto p-6">

    <!-- SIDEBAR -->
    <aside class="sidebar flex flex-col gap-6">
      <div class="flex items-center gap-3">
        <img id="profile-pic"
             src="https://raw.githubusercontent.com/bookscoffeedreams/bookscoffeedreams.github.io/refs/heads/main/assets/images/account_logo_default.png"
             class="w-12 h-12 rounded-full object-cover border border-white/40" />
        <div class="leading-tight w-full overflow-hidden">
          <div id="profile-name" class="font-semibold truncate max-w-[170px] block">Admin</div>
          <div id="profile-email" class="text-xs muted truncate max-w-[170px] block">‚Äî</div>
        </div>
      </div>

      <nav class="flex flex-col gap-1 text-[15px]">
        <div id="nav-banners" class="nav-item nav-active"><svg class="w-5 h-5" viewBox="0 0 24 24" fill="none"><path d="M3 6h18v12H3z" stroke="#4c1d95" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg><span>Banners</span></div>
        <div id="nav-services" class="nav-item"><svg class="w-5 h-5" viewBox="0 0 24 24" fill="none"><path d="M6 20h12M12 4v16" stroke="#4c1d95" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg><span>Services</span></div>
        <div id="nav-testimonials" class="nav-item"><svg class="w-5 h-5" viewBox="0 0 24 24" fill="none"><path d="M4 6h16v12H4z" stroke="#b91c1c" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg><span>Testimonials</span></div>
        <div id="nav-announcements" class="nav-item"><svg class="w-5 h-5" viewBox="0 0 24 24" fill="none"><path d="M15 8l5 3-5 3V8zM4 15V9a1 1 0 011-1h5l5-3v12l-5-3H5a1 1 0 01-1-1z" stroke="#d946ef" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg><span>Announcements</span></div>
      <div id="nav-icons" class="nav-item">
  <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none">
    <path d="M4 4h16v16H4z" stroke="#6d28d9" stroke-width="1.5"/>
  </svg>
  <span>Icons Library</span>
</div>
      </nav>

      <div class="mt-2">
        <button id="btn-signout" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-2 rounded-md font-semibold">Sign out</button>
      </div>

      <div class="text-xs muted mt-3">
        Books Coffee and Dreams ‚Äî Admin<br />
        Signed in as <span id="signed-role">admin</span>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="flex-1 space-y-6">

      <div class="card">
        <div class="flex items-start justify-between">
          <div>
            <h1 class="text-2xl font-bold">Manage Content | BCD</h1>
            <p class="muted mt-1">Manage Banner, Service cards, Testimonial cards and Announcements</p>
          </div>
          <div class="text-right muted small"></div>
        </div>
      </div>

      <!-- BANNERS (kept as-is) -->
      <section id="view-banners" class="card">
        <div class="flex items-start justify-between">
          <div>
            <h2 class="text-xl font-semibold">Banners</h2>
            <p class="muted mt-1">Large preview cards shown on homepage. (Full-width preview when placed above services.)</p>
          </div>
          <div class="text-sm muted">
            Cloudinary: <strong id="cloud-name-display">dkxuilgai</strong>
          </div>
        </div>

        <div class="mt-4 grid gap-3">
          <div class="grid sm:grid-cols-3 gap-3 items-center">
            <input id="bannerFile" type="file" accept="image/*" class="p-2 border input-rounded" />
          </div>

          <div class="flex gap-2 mt-2">
            <button id="uploadBannerBtn" class="bg-indigo-600 text-white py-2 px-4 rounded-md font-semibold">Upload Banner</button>
            <button id="clearBannerForm" class="bg-white border py-2 px-4 rounded-md">Clear</button>
            <div id="bannerUploadStatus" class="muted ml-3"></div>
          </div>
        </div>

        <hr class="my-4" />

        <div id="bannersList" class="space-y-4">
          <!-- realtime banners appended here (sortable) -->
        </div>
      </section>

      <!-- SERVICES -->
      <section id="view-services" class="card hidden">
        <h2 class="text-xl font-semibold mb-3">Services</h2>

        <div class="grid md:grid-cols-3 gap-3 mb-4">
          <input id="serviceTitle" placeholder="Service Title" class="p-2 border input-rounded" />
          <input id="serviceIcon" placeholder="Icon (emoji or 1 char)" class="p-2 border input-rounded" />
          <input id="serviceDesc" placeholder="Description" class="p-2 border input-rounded" />
          <button id="addServiceBtn" class="col-span-3 bg-purple-600 text-white py-2 rounded-md font-semibold">Add Service</button>
        </div>

        <div id="serviceList" class="space-y-3"></div>
      </section>

      <!-- TESTIMONIALS -->
      <section id="view-testimonials" class="card hidden">
        <h2 class="text-xl font-semibold mb-3">Testimonials</h2>

        <div class="grid md:grid-cols-3 gap-3 mb-4">
          <input id="testName" placeholder="Name" class="p-2 border input-rounded" />
          <input id="testCountry" placeholder="Country" class="p-2 border input-rounded" />
          <input id="testMessage" placeholder="Message" class="p-2 border input-rounded" />
          <button id="addTestimonialBtn" class="col-span-3 bg-fuchsia-600 text-white py-2 rounded-md font-semibold">Add Testimonial</button>
        </div>

        <div id="testimonialList" class="space-y-3"></div>
      </section>

      <!-- ANNOUNCEMENTS -->
      <section id="view-announcements" class="card hidden">
        <h2 class="text-xl font-semibold mb-3">Announcements</h2>

        <form id="announceForm" class="mb-4">
          <textarea id="announceMessage" rows="3" placeholder="Write announcement..." class="w-full p-2 border input-rounded"></textarea>
          <div class="mt-3">
            <button id="postAnnouncementBtn" class="bg-pink-600 text-white py-2 px-4 rounded-md font-semibold">Post Announcement</button>
          </div>
        </form>

        <div id="announcementsList" class="space-y-3"></div>
      </section>

      <!-- ICONS LIBRARY (NEW PREMIUM UI) -->
      <section id="view-icons" class="card hidden">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-xl font-semibold">Subject & Chapter Icons Library</h2>
            <p class="muted mt-1">Create subjects and upload chapter icons. Click a subject to expand its icons.</p>
          </div>
          <div class="flex items-center gap-3">
            <button id="btn-add-subject" class="bg-white border py-2 px-3 rounded-md font-semibold">+ Add Subject</button>
          </div>
        </div>

        <div id="subjectsGrid" class="subjects-grid">
          <!-- subject cards render here -->
        </div>

        <!-- hidden file inputs used for uploads -->
        <input id="hiddenChapterFile" type="file" accept="image/*" style="display:none" />
        <input id="hiddenSubjectIconFile" type="file" accept="image/*" style="display:none" />
      </section>

    </main>
  </div>

  <!-- FIREBASE + APP SCRIPT -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, doc, addDoc, getDocs, deleteDoc,
      updateDoc, onSnapshot, query, orderBy, serverTimestamp, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // Firebase config (your existing config)
    const firebaseConfig = {
      apiKey: "AIzaSyACEG_4v-3ROgMNOlFZsAllC9VcYb8Nm2A",
      authDomain: "bcd-discord.firebaseapp.com",
      projectId: "bcd-discord",
      storageBucket: "bcd-discord.appspot.com",
      messagingSenderId: "278895155371",
      appId: "1:278895155371:web:177a468f5fa3f0abfe3fee"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();

    // UI refs
    const profilePic = document.getElementById("profile-pic");
    const profileName = document.getElementById("profile-name");
    const profileEmail = document.getElementById("profile-email");
    const signedRole = document.getElementById("signed-role");

    const navBanners = document.getElementById("nav-banners");
    const navServices = document.getElementById("nav-services");
    const navTestimonials = document.getElementById("nav-testimonials");
    const navAnnouncements = document.getElementById("nav-announcements");
    const navIcons = document.getElementById("nav-icons");

    const viewBanners = document.getElementById("view-banners");
    const viewServices = document.getElementById("view-services");
    const viewTestimonials = document.getElementById("view-testimonials");
    const viewAnnouncements = document.getElementById("view-announcements");
    const viewIcons = document.getElementById("view-icons");

    // banners
    const bannersList = document.getElementById("bannersList");
    const bannerFile = document.getElementById("bannerFile");
    const uploadBannerBtn = document.getElementById("uploadBannerBtn");
    const uploadStatus = document.getElementById("bannerUploadStatus");

    // services
    const serviceList = document.getElementById("serviceList");
    const addServiceBtn = document.getElementById("addServiceBtn");

    // testimonials
    const testimonialList = document.getElementById("testimonialList");
    const addTestimonialBtn = document.getElementById("addTestimonialBtn");

    // announcements
    const announcementsList = document.getElementById("announcementsList");

    // icons ui
    const subjectsGrid = document.getElementById('subjectsGrid');
    const btnAddSubject = document.getElementById('btn-add-subject');
    const hiddenChapterFile = document.getElementById('hiddenChapterFile');
    const hiddenSubjectIconFile = document.getElementById('hiddenSubjectIconFile');

    // NAV helpers
    function showView(name) {
      [viewBanners, viewServices, viewTestimonials, viewAnnouncements, viewIcons]
    .forEach(v => v.classList.add("hidden"));
      if (name === "banners") viewBanners.classList.remove("hidden");
      if (name === "services") viewServices.classList.remove("hidden");
      if (name === "testimonials") viewTestimonials.classList.remove("hidden");
      if (name === "announcements") viewAnnouncements.classList.remove("hidden");
      if (name === "icons") viewIcons.classList.remove("hidden");

      document.querySelectorAll(".nav-item").forEach(n => n.classList.remove("nav-active"));
      document.getElementById("nav-" + name).classList.add("nav-active");
    }
    // default
    showView("banners");

    navBanners.onclick = () => showView("banners");
    navServices.onclick = () => showView("services");
    navTestimonials.onclick = () => showView("testimonials");
    navAnnouncements.onclick = () => showView("announcements");
    navIcons.onclick = () => showView("icons");

    // Profile & auth (fill profile, check role)
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        profileName.textContent = "Not signed in";
        profileEmail.textContent = "";
        signedRole.textContent = "guest";
        return;  // guard.js handles redirect if needed
      }

      // Load user doc (optional)
      let data = {};
      try {
        const udoc = await getDoc(doc(db, "users", user.uid));
        if (udoc.exists()) data = udoc.data();
      } catch (e) {
        console.error("Failed to read user doc:", e);
      }

      const defaultPhoto =
        "https://raw.githubusercontent.com/bookscoffeedreams/bookscoffeedreams.github.io/refs/heads/main/assets/images/account_logo_default.png";

      const finalPhoto = data.photoURL || data.profileURL || user.photoURL || defaultPhoto;

      profilePic.src = finalPhoto;
      profileName.textContent = data.name || user.displayName || "Admin";
      profileEmail.textContent = data.email || user.email;
      signedRole.textContent = data.role || "admin";
    });

    // Utility escapeHtml
    function escapeHtml(str='') { return String(str || '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[s]); }

    // Upload helper (Cloudinary unsigned preset kept as before)
    async function uploadToCloudinary(file) {
      const cloudName = "dkxuilgai";
      const preset = "bcd_courses";
      const folder = "bcd_courses";
      const url = `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`;
      const fd = new FormData();
      fd.append("file", file);
      fd.append("upload_preset", preset);
      fd.append("folder", folder);

      // small UI hint
      try { uploadStatus.textContent = "Uploading..."; } catch(e){/*no-op*/}

      const res = await fetch(url, { method: "POST", body: fd });
      if (!res.ok) {
        const txt = await res.text();
        throw new Error("Cloudinary upload failed: " + txt);
      }
      const json = await res.json();
      try { uploadStatus.textContent = "Uploaded"; } catch(e){/*no-op*/}
      return json.secure_url || json.url;
    }

    // ---------------------- BANNERS (kept original logic but safer) ----------------------
    import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js').then(() => {
      const bannersQuery = query(collection(db, "banners"), orderBy("order"));
      if (bannersQuery) {
        onSnapshot(bannersQuery, snap => {
          bannersList.innerHTML = "";
          const frag = document.createDocumentFragment();
          snap.forEach(docSnap => {
            const d = docSnap.data();
            const id = docSnap.id;
            const wrapper = document.createElement("div");
            wrapper.className = "p-3 bg-white rounded-lg shadow-sm";
            wrapper.setAttribute("data-id", id);

            // safer DOM build
            const row = document.createElement('div'); row.className = "flex flex-col md:flex-row md:items-center gap-4";
            const img = document.createElement('img'); img.className = "big-banner-preview md:w-2/3";
            img.alt = d.title || '';
            img.src = d.imageUrl || '';
            img.onerror = function(){ this.style.opacity=0.6; this.style.filter='grayscale(40%)'; };
            const info = document.createElement('div'); info.className = "flex-1 flex flex-col gap-2";
            const top = document.createElement('div'); top.className = "flex items-center justify-between";
            const left = document.createElement('div');
            const titleEl = document.createElement('div'); titleEl.className='font-semibold text-lg'; titleEl.textContent = d.title || '‚Äî';
            const linkEl = document.createElement('div'); linkEl.className='muted text-sm'; linkEl.textContent = d.link || '';
            left.appendChild(titleEl); left.appendChild(linkEl);
            const right = document.createElement('div'); right.className='flex gap-2';
            const editBtn = document.createElement('button'); editBtn.className='edit-banner text-indigo-600 font-medium'; editBtn.dataset.id = id; editBtn.textContent='Edit';
            const delBtn = document.createElement('button'); delBtn.className='del-banner text-red-600 font-medium'; delBtn.dataset.id = id; delBtn.textContent='Delete';
            right.appendChild(editBtn); right.appendChild(delBtn);
            top.appendChild(left); top.appendChild(right);
            const createdEl = document.createElement('div'); createdEl.className='muted text-sm'; createdEl.textContent = 'Added: ' + (d.createdAt ? (d.createdAt.toDate ? d.createdAt.toDate().toLocaleString() : String(d.createdAt)) : '‚Äî');
            const orderEl = document.createElement('div'); orderEl.className='muted text-sm'; orderEl.textContent = 'Order: ' + (typeof d.order === 'number' ? d.order : '‚Äî');
            info.appendChild(top); info.appendChild(createdEl); info.appendChild(orderEl);
            row.appendChild(img); row.appendChild(info);
            wrapper.appendChild(row);
            frag.appendChild(wrapper);
          });
          bannersList.appendChild(frag);

          // attach handlers
          bannersList.querySelectorAll('.del-banner').forEach(btn => {
            btn.onclick = async (e) => {
              const id = e.currentTarget.dataset.id;
              const res = await Swal.fire({ title: 'Delete banner?', text: 'This will remove the banner permanently.', icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444' });
              if (res.isConfirmed) {
                await deleteDoc(doc(db, "banners", id));
                Swal.fire('Deleted', '', 'success');
              }
            };
          });

          bannersList.querySelectorAll('.edit-banner').forEach(btn => {
            btn.onclick = async (e) => {
              const id = e.currentTarget.dataset.id;
              const docRef = doc(db, "banners", id);
              const docSnap = await getDoc(docRef);
              const data = docSnap.data();
              const { value } = await Swal.fire({
                title: 'Edit Banner',
                html:
                  `<input id="swal-title" class="swal2-input" placeholder="Title" value="${escapeHtml(data.title||'')}">` +
                  `<input id="swal-link" class="swal2-input" placeholder="Link" value="${escapeHtml(data.link||'')}">` +
                  `<input id="swal-image" class="swal2-input" placeholder="Image URL" value="${escapeHtml(data.imageUrl||'')}">`,
                preConfirm: () => ({
                  title: document.getElementById('swal-title').value,
                  link: document.getElementById('swal-link').value,
                  imageUrl: document.getElementById('swal-image').value
                }),
                width: 650
              });
              if (value) {
                await updateDoc(docRef, { title: value.title, link: value.link, imageUrl: value.imageUrl });
                Swal.fire('Saved', '', 'success');
              }
            };
          });

          // make sortable
          if (window._bannersSortable) window._bannersSortable.destroy();
          window._bannersSortable = new Sortable(bannersList, {
            animation: 160,
            handle: '.big-banner-preview',
            onEnd: async () => {
              const items = Array.from(bannersList.children);
              for (let i = 0; i < items.length; i++) {
                const id = items[i].getAttribute('data-id');
                await updateDoc(doc(db, "banners", id), { order: i });
              }
              Swal.fire({ icon: 'success', title: 'Order saved', timer: 900, showConfirmButton: false });
            }
          });
        });
      }
    });

    // ===================== Services realtime + sortable =====================
    onSnapshot(query(collection(db, "services"), orderBy("order")), snap => {
      serviceList.innerHTML = "";
      const frag = document.createDocumentFragment();
      snap.forEach(docSnap => {
        const d = docSnap.data();
        const id = docSnap.id;
        const el = document.createElement("div");
        el.className = "p-3 bg-white rounded-md flex justify-between items-center cursor-move";
        el.setAttribute("data-id", id);
        el.innerHTML = `<div class="flex items-center gap-3"><div class="text-2xl">${escapeHtml(d.icon||'‚ú®')}</div><div><div class="font-semibold">${escapeHtml(d.title||'‚Äî')}</div><div class="muted text-sm">${escapeHtml(d.description||'')}</div></div></div><div class="flex gap-2"><button class="edit-service text-indigo-600" data-id="${id}">Edit</button><button class="del-service text-red-600" data-id="${id}">Delete</button></div>`;
        frag.appendChild(el);
      });
      serviceList.appendChild(frag);

      // handlers
      serviceList.querySelectorAll('.del-service').forEach(b => b.onclick = async (e) => {
        const id = e.currentTarget.dataset.id;
        await deleteDoc(doc(db, "services", id));
      });
      serviceList.querySelectorAll('.edit-service').forEach(b => b.onclick = async (e) => {
        const id = e.currentTarget.dataset.id;
        const docRef = doc(db, "services", id);
        const snap = await getDoc(docRef);
        const d = snap.data();
        const { value } = await Swal.fire({
          title: 'Edit Service',
          html: `<input id="st" class="swal2-input" value="${escapeHtml(d.title||'')}"><input id="si" class="swal2-input" value="${escapeHtml(d.icon||'')}"><input id="sd" class="swal2-input" value="${escapeHtml(d.description||'')}">`,
          preConfirm: () => ({ title: document.getElementById("st").value, icon: document.getElementById("si").value, description: document.getElementById("sd").value })
        });
        if (value) await updateDoc(docRef, value);
      });

      // sortable for services
      if (window._servicesSortable) window._servicesSortable.destroy();
      window._servicesSortable = new Sortable(serviceList, {
        animation: 150,
        onEnd: async () => {
          const items = Array.from(serviceList.children);
          for (let i = 0; i < items.length; i++) {
            const id = items[i].getAttribute('data-id');
            await updateDoc(doc(db, "services", id), { order: i });
          }
          Swal.fire({ icon: 'success', title: 'Order saved', timer: 700, showConfirmButton: false });
        }
      });
    });

    // ===================== Testimonials realtime =====================
    onSnapshot(collection(db, "testimonials"), snap => {
      testimonialList.innerHTML = "";
      const frag = document.createDocumentFragment();
      snap.forEach(docSnap => {
        const d = docSnap.data();
        const id = docSnap.id;
        const el = document.createElement("div");
        el.className = "p-3 bg-white rounded-md flex justify-between items-center";
        el.innerHTML = `<div><div class="font-semibold">${escapeHtml(d.name||'‚Äî')}</div><div class="muted text-sm">${escapeHtml(d.country||'')}</div><div class="mt-2">${escapeHtml(d.message||'')}</div></div><div class="flex gap-2"><button class="edit-test text-indigo-600" data-id="${id}">Edit</button><button class="del-test text-red-600" data-id="${id}">Delete</button></div>`;
        frag.appendChild(el);
      });
      testimonialList.appendChild(frag);

      testimonialList.querySelectorAll('.del-test').forEach(b => b.onclick = async (e) => {
        const id = e.currentTarget.dataset.id; await deleteDoc(doc(db, "testimonials", id));
      });
      testimonialList.querySelectorAll('.edit-test').forEach(b => b.onclick = async (e) => {
        const id = e.currentTarget.dataset.id; const ref = doc(db, "testimonials", id); const s = await getDoc(ref); const d = s.data();
        const { value } = await Swal.fire({ title: 'Edit Testimonial', html: `<input id="tn" class="swal2-input" value="${escapeHtml(d.name||'')}"><input id="tc" class="swal2-input" value="${escapeHtml(d.country||'')}"><textarea id="tm" class="swal2-textarea">${escapeHtml(d.message||'')}</textarea>`, preConfirm: () => ({ name: document.getElementById("tn").value, country: document.getElementById("tc").value, message: document.getElementById("tm").value })});
        if (value) await updateDoc(ref, value);
      });
    });

    // ===================== Announcements realtime =====================
    onSnapshot(query(collection(db, "announcements"), orderBy("createdAt", "desc")), snap => {
      announcementsList.innerHTML = "";
      const frag = document.createDocumentFragment();
      snap.forEach(docSnap => {
        const d = docSnap.data();
        const id = docSnap.id;
        const el = document.createElement("div");
        el.className = "p-3 bg-white rounded-md flex justify-between items-start";
        el.innerHTML = `<div><div>${escapeHtml(d.message || '')}</div><div class="muted text-xs mt-2">${d.createdAt ? (d.createdAt.toDate ? d.createdAt.toDate().toLocaleString() : String(d.createdAt)) : ''}</div></div><div><button class="del-ann text-red-600" data-id="${id}">Delete</button></div>`;
        frag.appendChild(el);
      });
      announcementsList.appendChild(frag);

      announcementsList.querySelectorAll('.del-ann').forEach(b => b.onclick = async (e) => {
        const id = e.currentTarget.dataset.id; await deleteDoc(doc(db, "announcements", id));
      });
    });

    // ===================== ICONS: Subjects & Chapter Icons (Option 1 structure) =====================

    // Render subjects (called on snapshot)
    async function renderSubjectsFromSnapshot(snapshot) {
      subjectsGrid.innerHTML = '';
      const subjects = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => ('' + (a.name||'')).localeCompare(b.name||''));
      if (subjects.length === 0) {
        subjectsGrid.innerHTML = '<div class="muted">No subjects yet ‚Äî click "Add Subject" to create one.</div>';
        return;
      }

      // Pre-fetch chapter counts to avoid N+1 queries: fetch all chapters once
      const chapterSnap = await getDocs(collection(db, 'chapter_icons'));
      const chapters = chapterSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      const chaptersBySubject = {};
      for (const ch of chapters) {
        if (!chaptersBySubject[ch.subjectId]) chaptersBySubject[ch.subjectId] = [];
        chaptersBySubject[ch.subjectId].push(ch);
      }

      for (const sub of subjects) {
        const card = document.createElement('div'); card.className = 'subject-card'; card.dataset.id = sub.id;

        // actions (open, rename, delete)
        const actions = document.createElement('div'); actions.className = 'subject-actions';
        const openBtn = document.createElement('button'); openBtn.className='btn-ghost'; openBtn.title='Open'; openBtn.innerHTML = 'üîΩ';
        const editBtn = document.createElement('button'); editBtn.className='btn-ghost'; editBtn.title='Rename'; editBtn.innerHTML='‚úèÔ∏è';
        const delBtn = document.createElement('button'); delBtn.className='btn-ghost'; delBtn.title='Delete'; delBtn.innerHTML='üóëÔ∏è';
        actions.appendChild(openBtn); actions.appendChild(editBtn); actions.appendChild(delBtn);

        // title block
        const title = document.createElement('div'); title.className='title';
        const badge = document.createElement('div'); badge.style.cssText = "width:40px;height:40px;border-radius:10px;background:linear-gradient(90deg,var(--accent1),var(--accent2));display:inline-flex;align-items:center;justify-content:center;color:#fff;font-weight:700;margin-right:8px";
        badge.textContent = escapeHtml((sub.name||'').slice(0,1).toUpperCase());
        title.appendChild(badge);
        const nameWrap = document.createElement('div'); nameWrap.innerHTML = `<div>${escapeHtml(sub.name || 'Untitled')}</div>`;
        title.appendChild(nameWrap);

        const meta = document.createElement('div'); meta.className='meta';
        const cnt = (chaptersBySubject[sub.id] || []).length;
        meta.textContent = `${cnt} icon${cnt === 1 ? '' : 's'}`;

        // chapter area (initially hidden)
        const chapterArea = document.createElement('div'); chapterArea.className = 'chapter-area';

        // fab (upload)
        const fab = document.createElement('button'); fab.className='fab-upload'; fab.innerHTML = '+'; fab.title = 'Upload chapter icon';

        card.appendChild(actions);
        card.appendChild(title);
        card.appendChild(meta);
        card.appendChild(chapterArea);
        card.appendChild(fab);
        subjectsGrid.appendChild(card);

        // DELETE subject: remove subject and its chapters
        delBtn.onclick = async () => {
          const res = await Swal.fire({ title: 'Delete subject?', text: `Delete "${sub.name}" and all its chapter icons?`, icon:'warning', showCancelButton:true });
          if (!res.isConfirmed) return;
          // delete chapters for this subject
          const csnap = await getDocs(query(collection(db, 'chapter_icons')));
          const deletes = [];
          csnap.forEach(c => { if (c.data().subjectId === sub.id) deletes.push(deleteDoc(doc(db,'chapter_icons', c.id))); });
          await Promise.all(deletes);
          await deleteDoc(doc(db, 'subject_icons', sub.id));
          Swal.fire('Deleted','', 'success');
        };

        // Rename subject
        editBtn.onclick = async () => {
          const { value: newName } = await Swal.fire({ title:'Rename Subject', input:'text', inputValue: sub.name || '', showCancelButton:true });
          if (newName && newName.trim()) await updateDoc(doc(db,'subject_icons', sub.id), { name: newName.trim() });
        };

        // Open/close subject: render chapter icons
        openBtn.onclick = async () => {
          if (card.classList.contains('expanded')) { card.classList.remove('expanded'); chapterArea.innerHTML = ''; return; }
          card.classList.add('expanded');
          chapterArea.innerHTML = '<div class="muted">Loading icons...</div>';

          // get chapters for this subject (we already fetched earlier; better to query live for up-to-date)
          const cSnap = await getDocs(query(collection(db,'chapter_icons'), orderBy('createdAt')));
          const chs = [];
          cSnap.forEach(c => { if (c.data().subjectId === sub.id) chs.push({ id: c.id, ...c.data() }); });

          meta.textContent = `${chs.length} icon${chs.length === 1 ? '' : 's'}`;

          const grid = document.createElement('div'); grid.className = 'chapter-grid';
          if (chs.length === 0) {
            grid.innerHTML = '<div class="muted">No chapter icons yet ‚Äî upload one.</div>';
          } else {
            for (const ch of chs) {
              const tile = document.createElement('div'); tile.className = 'chapter-tile';
              const img = document.createElement('img'); img.src = ch.url; img.alt = ch.name || '';
              tile.appendChild(img);

              const chActions = document.createElement('div'); chActions.className = 'chapter-actions';
              const viewCh = document.createElement('button'); viewCh.className = 'btn-ghost'; viewCh.innerHTML = 'üîé'; viewCh.title='View';
              const delCh = document.createElement('button'); delCh.className = 'btn-ghost'; delCh.innerHTML = 'üóëÔ∏è'; delCh.title='Delete';
              chActions.appendChild(viewCh); chActions.appendChild(delCh);
              tile.appendChild(chActions);
              grid.appendChild(tile);

              viewCh.onclick = () => Swal.fire({ imageUrl: ch.url, imageAlt: ch.name || 'icon', showConfirmButton: true });
              delCh.onclick = async () => {
                const r = await Swal.fire({ title:'Delete icon?', icon:'warning', showCancelButton:true });
                if (!r.isConfirmed) return;
                await deleteDoc(doc(db,'chapter_icons', ch.id));
                Swal.fire('Deleted','', 'success');
              };
            }
          }

          chapterArea.innerHTML = '';
          chapterArea.appendChild(grid);

          // wire fab -> upload for this subject (one-time handler per open)
          fab.onclick = async () => {
            hiddenChapterFile.onchange = async (e) => {
              const file = e.target.files[0]; if (!file) return;
              Swal.fire({ title:'Uploading...', allowOutsideClick:false, didOpen(){ Swal.showLoading(); } });
              try {
                const url = await uploadToCloudinary(file);
                await addDoc(collection(db,'chapter_icons'), { subjectId: sub.id, url, createdAt: serverTimestamp() });
                Swal.close();
                Swal.fire('Uploaded','', 'success');
              } catch (err) {
                Swal.close();
                Swal.fire('Upload failed', err.message || String(err), 'error');
              }
              hiddenChapterFile.value = '';
            };
            hiddenChapterFile.click();
          };
        };

        // subscribe to live chapter count update for this subject (keeps meta fresh)
        onSnapshot(collection(db, 'chapter_icons'), snapCh => {
          const cntLive = snapCh.docs.filter(c => c.data().subjectId === sub.id).length;
          meta.textContent = `${cntLive} icon${cntLive === 1 ? '' : 's'}`;
        });
      }
    }

    // Add Subject (modal with optional subject icon)
    btnAddSubject.onclick = async () => {
      const { value: formValues } = await Swal.fire({
        title: 'Create Subject',
        html:
          `<input id="swal-subject-name" class="swal2-input" placeholder="Subject name (e.g. Physics)">` +
          `<div class="small-muted" style="text-align:left;font-size:13px;margin-top:4px">Optional: upload subject thumbnail after creation (or use edit).</div>`,
        focusConfirm: false,
        showCancelButton: true,
        preConfirm: () => {
          return { name: document.getElementById('swal-subject-name').value.trim() };
        }
      });
      if (!formValues || !formValues.name) return;
      // create subject
      const subRef = await addDoc(collection(db, 'subject_icons'), { name: formValues.name, createdAt: serverTimestamp() });
      confetti({ particleCount: 50, spread: 60, origin: { y: 0.6 } });
      // re-render will be triggered by snapshot
    };

    // Real-time subjects listener -> re-render
    onSnapshot(query(collection(db,'subject_icons'), orderBy('name')), snapshot => {
      renderSubjectsFromSnapshot(snapshot).catch(console.error);
    });

    // -------------------- Add handlers for old upload buttons removed (we removed them from UI) --------------------

    // -------------------- Banner upload handler (kept) --------------------
    uploadBannerBtn.onclick = async () => {
      try {
        const file = bannerFile.files[0];
        if (!file) return Swal.fire('No file', 'Please choose an image file to upload.', 'warning');
        uploadBannerBtn.disabled = true;
        const imageUrl = await uploadToCloudinary(file);

        // delete existing banners (allow only one)
        const snap = await getDocs(collection(db, "banners"));
        const deletes = [];
        snap.forEach((docSnap) => { deletes.push(deleteDoc(doc(db, "banners", docSnap.id))); });
        await Promise.all(deletes);

        await addDoc(collection(db, "banners"), { imageUrl, createdAt: serverTimestamp(), order: 0 });

        bannerFile.value = '';
        uploadStatus.textContent = '';
        confetti({ particleCount: 60, spread: 60, origin: { y: 0.6 } });
        Swal.fire({ icon: 'success', title: 'Banner updated', timer: 900, showConfirmButton: false });
      } catch (err) {
        console.error(err);
        Swal.fire('Upload error', err.message || String(err), 'error');
      } finally {
        uploadBannerBtn.disabled = false;
      }
    };

    // Services add
    addServiceBtn.onclick = async () => {
      const title = document.getElementById("serviceTitle").value.trim();
      const icon = document.getElementById("serviceIcon").value.trim();
      const desc = document.getElementById("serviceDesc").value.trim();
      if (!title || !desc) return Swal.fire("Missing", "Please fill title and description.", "warning");
      const count = (await getDocs(collection(db, "services"))).size;
      await addDoc(collection(db, "services"), { title, icon, description: desc, order: count, createdAt: serverTimestamp() });
      document.getElementById("serviceTitle").value = '';
      document.getElementById("serviceIcon").value = '';
      document.getElementById("serviceDesc").value = '';
      confetti();
    };

    // Testimonials add
    addTestimonialBtn.onclick = async () => {
      const name = document.getElementById("testName").value.trim();
      const country = document.getElementById("testCountry").value.trim();
      const message = document.getElementById("testMessage").value.trim();
      if (!name || !message) return Swal.fire("Missing", "Please fill name and message.", "warning");
      await addDoc(collection(db, "testimonials"), { name, country, message, createdAt: serverTimestamp() });
      document.getElementById("testName").value = '';
      document.getElementById("testCountry").value = '';
      document.getElementById("testMessage").value = '';
      confetti();
    };

    // Announce
    document.getElementById("announceForm").onsubmit = async (e) => {
      e.preventDefault();
      const msg = document.getElementById("announceMessage").value.trim();
      if (!msg) return Swal.fire('Missing', 'Announcement cannot be empty', 'warning');
      await addDoc(collection(db, "announcements"), { message: msg, createdAt: serverTimestamp() });
      document.getElementById("announceMessage").value = '';
      confetti();
    };

    // Sign out
    document.getElementById("btn-signout").onclick = async () => {
      try { await signOut(auth); location.reload(); } catch (err) { console.error(err); Swal.fire('Error', err.message, 'error'); }
    };

  </script>

  <script type="module">
    import { requirePermission } from "/admin/guard-v10.js";
    await requirePermission("manageContent"); // FULL ACCESS TO THIS PAGE
  </script>
</body>
</html>
